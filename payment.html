<div class="mermaid">
flowchart TD
    A[รับข้อมูลงวดหนี้]:::start --> B[ตรวจสอบวันที่ชำระ]:::process
    B -->|ชำระก่อนหรือครบกำหนด| C[ดอกเบี้ยผิดนัด = 0]:::success
    B -->|ชำระเกินกำหนด| D[คำนวณจำนวนวันผิดนัด]:::process
    D --> E[คำนวณดอกเบี้ยผิดนัดใหม่<br>New Default Interest = Remaining Principal × (Rate / 100) × (Days Overdue / 365)]:::process
    E --> F[รวมยอดหนี้ทั้งหมด<br>Total Debt = Principal + Interest + Penalty + Old Default + New Default]:::process
    F --> G[ตัดชำระเงินจริงตามลำดับ<br>New Default → Old Default → Penalty → Interest → Principal]:::process
    G --> H[ปรับยอดคงเหลือและสถานะ]:::process
    H --> I{ยอดชำระมากกว่าหนี้หรือไม่}:::decision
    I -->|ใช่| J[เก็บเป็น Overpayment]:::success
    I -->|ไม่ใช่| K[อัปเดตสถานะงวด<br>“ชำระครบแล้ว” / “ค้างชำระ” / “ยังไม่ถึงกำหนด”]:::process
    J --> L[อัปเดตตารางรายละเอียดและประวัติการชำระ]:::end
    K --> L

    classDef start fill:#ffe0f0,stroke:#e91e63,color:#880e4f,font-weight:bold;
    classDef process fill:#ffd1e8,stroke:#e91e63,color:#880e4f,font-weight:bold;
    classDef decision fill:#ffc1f0,stroke:#e91e63,color:#880e4f,font-weight:bold;
    classDef success fill:#ffb3d9,stroke:#e91e63,color:#880e4f,font-weight:bold;
    classDef end fill:#ff99cc,stroke:#e91e63,color:#880e4f,font-weight:bold;
</div>
