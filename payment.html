<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ‚Äî‚Äî‚Äî CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî‚Äî‚Äî */
body { font-family: 'Sarabun', sans-serif; background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), url('https://i.postimg.cc/507bjy9Z/cdd.png') center/cover no-repeat fixed; display: flex; flex-direction: column; align-items: center; gap: 30px; padding:20px;}
.container {border-radius: 25px; padding: 30px; box-shadow: 0 8px 25px rgba(233, 30, 99, 0.3); width: 100%; max-width: 600px; background-color: rgba(255, 255, 255, 0.92);}
.header-section{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:10px;}
.logos img{height:60px;margin-left:5px;}
.result-box { margin-top: 10px; padding: 10px; border: 2px dashed #f06292; border-radius: 15px; background-color: #fff8fa; text-align: center; font-size: 1rem; font-weight: bold; color: #880e4f; }
.table-container { border-radius: 25px; padding: 30px; box-shadow: 0 8px 25px rgba(0, 81, 150, 0.3); width: 100%; max-width: 1200px; background-color: rgba(255, 255, 255, 0.95); }
.table-wrapper { overflow-x: auto; max-height: 400px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; white-space: nowrap; }
thead th { background-color: #002D62; color: white; position: sticky; top: 0; }
</style>
</head>
<body>

<div class="container">
  <div class="header-section">
    <div class="header-text">
      <h1>‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h1>
      <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>
    </div>
    <div class="logos">
      <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD Logo" />
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANdGcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Women Fund Logo" />
    </div>
  </div>

  <!-- Manual Calculator -->
  <div class="calculator-card">
    <p style="text-align:center; font-weight:bold; color:#880e4f;">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Manual)</p>
    <div class="input-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</label><input type="text" id="principal" onkeyup="formatNumberInput(this)"></div>
    <div class="input-group"><label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</label><input type="number" id="rate" value="5" readonly></div>
    <div class="input-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label><input type="date" id="dueDate"></div>
    <div class="input-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞</label><input type="date" id="paymentDateCalc"></div>
    <button class="calc-button" onclick="calculateInterest()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î</button>
    <div id="result" class="result-box">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: 0.00 ‡∏ö‡∏≤‡∏ó</div>
    <div id="overdue-days-box" class="result-box" style="background-color:#fffaf0; color:#d35400;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î: 0 ‡∏ß‡∏±‡∏ô</div>
    <div id="overdue-amount-box" class="result-box" style="background-color:#fffaf0; color:#c0392b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î: 0.00 ‡∏ö‡∏≤‡∏ó</div>

    <hr>
    <p style="text-align:center; font-weight:bold; color:#155724;">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</p>
    <div class="input-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label><input type="number" id="paymentAmount"></div>
    <div class="input-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</label><input type="date" id="actualPaymentDate"></div>
    <button class="calc-button settle-button" onclick="settlePayment()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
  </div>
</div>

<!-- Upload Excel -->
<div class="table-container">
  <h2>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel</h2>
  <input type="file" id="excel-file" accept=".xlsx,.xls,.csv">
  <div class="table-wrapper">
    <table id="payment-table">
      <thead><tr><th>‡∏á‡∏ß‡∏î</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
      <tbody id="payment-table-body"><tr><td colspan="4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel...</td></tr></tbody>
    </table>
  </div>
</div>

<!-- History Table -->
<div class="table-container">
  <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞</h2>
  <div class="table-wrapper">
    <table id="history-table">
      <thead>
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</th>
          <th>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th>
          <th>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th>
          <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î</th>
        </tr>
      </thead>
      <tbody id="history-table-body"><tr><td colspan="7">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</td></tr></tbody>
    </table>
  </div>
</div>

<script>
let allInstallments = [];
let paymentHistory = [];

/* üì• ‡πÇ‡∏´‡∏•‡∏î Excel */
document.getElementById('excel-file').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    allInstallments = json.map((row, i) => ({
      id: i,
      sequence: row['‡∏á‡∏ß‡∏î'] || (i+1),
      dueDate: formatExcelDate(row['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞']),
      principal: Number(row['‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô']) || 0,
      status: row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'
    }));
    renderInstallmentTable();
  };
  reader.readAsArrayBuffer(file);
});

/* üìä Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏ß‡∏î */
function renderInstallmentTable(){
  const tbody = document.getElementById('payment-table-body');
  tbody.innerHTML = '';
  allInstallments.forEach(inst=>{
    tbody.innerHTML += `<tr>
      <td>${inst.sequence}</td>
      <td>${formatDate(inst.dueDate)}</td>
      <td style="text-align:right;">${inst.principal.toLocaleString()}</td>
      <td>${inst.status}</td>
    </tr>`;
  });
}

/* üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Manual */
function calculateInterest(){
  const p = parseFloat(document.getElementById('principal').value.replace(/,/g,''))||0;
  const r = parseFloat(document.getElementById('rate').value)||0;
  const due = new Date(document.getElementById('dueDate').value);
  const pay = new Date(document.getElementById('paymentDateCalc').value);
  due.setHours(0,0,0,0); pay.setHours(0,0,0,0);
  const days = Math.max(0, Math.floor((pay - due) / (1000*60*60*24)));
  const interest = (p * (r/100) * days) / 365;
  document.getElementById('result').innerHTML = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: ${interest.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
  document.getElementById('overdue-days-box').innerHTML = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î: ${days} ‡∏ß‡∏±‡∏ô`;
  document.getElementById('overdue-amount-box').innerHTML = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î: ${interest.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
}

/* üí∞ ‡∏ï‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Overdue ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå */
function settlePayment(){
  const amount = parseFloat(document.getElementById('paymentAmount').value);
  const payDateStr = document.getElementById('actualPaymentDate').value;
  if(!amount || !payDateStr){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
  const payDate = new Date(payDateStr); payDate.setHours(0,0,0,0);

  // ‡∏´‡∏≤ "‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"
  const nextInstallment = allInstallments.find(inst => inst.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞');
  if(!nextInstallment){ alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ß‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"); return; }

  const dueDate = new Date(nextInstallment.dueDate);
  dueDate.setHours(0,0,0,0);
  const daysOverdue = Math.max(0, Math.floor((payDate - dueDate) / (1000*60*60*24)));

  const rate = parseFloat(document.getElementById('rate').value)||5;
  const overdueInterest = (nextInstallment.principal * (rate/100) * daysOverdue)/365;

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
  paymentHistory.push({
    date: payDate,
    amount,
    sequence: nextInstallment.sequence,
    category: '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô',
    overdueDays: daysOverdue,
    overdueAmount: overdueInterest
  });

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏ß‡∏î
  nextInstallment.status = '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß';
  renderInstallmentTable();
  renderHistoryTable();
}

/* üìù ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
function renderHistoryTable(){
  const tbody = document.getElementById('history-table-body');
  tbody.innerHTML = '';
  if(paymentHistory.length===0){
    tbody.innerHTML = '<tr><td colspan="7">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</td></tr>';
    return;
  }
  paymentHistory.forEach(h=>{
    tbody.innerHTML += `
    <tr>
      <td>${formatDate(h.date)}</td>
      <td style="text-align:right;">${h.amount.toLocaleString()}</td>
      <td>${h.sequence}</td>
      <td>${h.category}</td>
      <td style="text-align:right;">${h.amount.toLocaleString()}</td>
      <td>${h.overdueDays}</td>
      <td style="text-align:right;">${h.overdueAmount.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
    </tr>`;
  });
}

/* üß≠ Helper */
function formatExcelDate(val){
  if(val instanceof Date) return val;
  if(typeof val === 'number'){ return new Date((val - 25569) * 86400 * 1000); }
  return new Date(val);
}
function formatDate(d){
  if(!d) return '';
  return new Date(d).toLocaleDateString('th-TH',{day:'2-digit',month:'2-digit',year:'numeric'});
}
function formatNumberInput(input){
  let value=input.value.replace(/,/g,'');
  if(!isNaN(value)&&value.length>0) input.value=parseFloat(value).toLocaleString('en-US');
}
</script>
</body>
</html>
