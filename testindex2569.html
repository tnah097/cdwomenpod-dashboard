<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CDDWomenfund Dashboard</title> 
  <!-- Chart.js, jQuery, DataTables -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    /* ===========================
       Theme & layout (user requested)
       - Pastel pink-purple gradient background
       - Cards, donut chart, province table
       - Header and logos unchanged
       - Table header locked to approx 2 lines (height ~70px)
       - Header text centered vertically and horizontally
       =========================== */

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #ffe6f0 0%, #f3e5f5 50%, #e1bee7 100%);
      background-attachment: fixed;
      color: #000;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 0.6s ease;
    }

    /* container that holds entire dashboard */
    .dashboard-container {
      padding: 28px 28px 60px 28px;
      background-color: rgba(255,255,255,0.92);
      max-width: 1500px;
      margin: 18px auto;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      min-height: calc(100vh - 36px);
      box-sizing: border-box;
    }

    .scale-control { font-size: 1rem; }

    /* header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .header-text {
      display: flex;
      flex-direction: column;
    }

    .header-text h1 { margin: 0; font-size: 2.4rem; line-height: 1; }
    .header-text h2 { margin: 0; font-size: 1.2rem; line-height: 1; color: #333; }

    .logo-container {
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .logo-container img { height: 60px; }

    /* small info line (date) */
    .info-line {
      color: navy;
      font-weight: bold;
      text-align: right;
      font-size: 1rem;
      margin-top: 6px;
    }

    /* ===== cards ===== */
    .cards {
      display: flex;
      gap: 16px;
      margin-top: 22px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      min-width: 240px;
      padding: 14px 16px;
      border-radius: 10px;
      color: white;
      font-weight: 700;
      box-sizing: border-box;
    }

    .card .subtitle { font-size: 0.95rem; color: #000; font-weight: 600; }
    .card .value { font-size: 1.6rem; color: #000; margin-top: 8px; font-weight: 500; white-space: nowrap; }

    .card.pink { background: linear-gradient(180deg,#e91e63,#d81b60); }
    .card.light-pink { background: linear-gradient(180deg,#f8bbd0,#f3a9c6); color: #000; }
    .card.orange { background: linear-gradient(180deg,#ff9800,#ffb24d); color: #000; }
    .card.pastel-pink { background: linear-gradient(180deg,#fce4ec,#f6cfe0); color: #000; }
    .card.deep-pastel-pink { background: linear-gradient(180deg,#f06292,#ec6790); color: #000; }

    /* responsive card layout */
    @media (max-width: 900px) {
      .card .value { font-size: 1.25rem; }
      .cards { gap: 10px; }
    }

    /* ===== visuals (left: donut, center image) ===== */
    .main-visuals {
      display: flex;
      margin-top: 24px;
      gap: 18px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .left, .center, .right { flex: 1; min-width: 300px; box-sizing: border-box; }
    .center { text-align: center; }

    #donutChart { width: 100% !important; height: 420px !important; max-height: 520px; }

    .section-title {
      text-align:center;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .center img { width: 320px; max-width: 80%; display: block; margin: 0 auto; }

    /* ===== province table wrapper and base styles ===== */
    .province-table-wrapper {
      margin-top: 26px;
      margin-left: 0;
      text-align: left !important;
      overflow: hidden;
    }

    .summary-table {
      width: 100% !important;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.85rem;
      color: #111;
      table-layout: fixed;
      min-width: 1100px; /* allow horizontal scroll on small screens */
    }

    /* HEADERS: locked height ~70px (approx 2 text lines), center vertical/horizontal */
    .summary-table thead th {
      background-color: #f06292;
      color: #000;
      padding: 8px 10px;
      border: 1px solid #f8bbd0;
      font-weight: 700;
      text-align: center;
      vertical-align: middle;
      white-space: normal; /* allow wrapping */
      word-break: break-word;
      line-height: 1.25;
      height: 70px;
      min-height: 70px;
      box-sizing: border-box;
    }

    /* Data cells: keep one-line overflow with ellipsis */
    .summary-table td {
      padding: 6px 8px;
      border: 1px solid #f8bbd0;
      color: #111;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }

    .summary-table tr:nth-child(even) { background-color: #fce4ec; }
    .summary-table tr:nth-child(odd) { background-color: #fff; }

    /* Link style for province */
    .province-link { color: #0645AD; text-decoration: underline; cursor: pointer; }
    .province-link:hover { color: #042a66; }

    /* Study center table (if used) */
    #studyCenterTable tbody tr { cursor: pointer; }
    #studyCenterTable tbody tr:hover { background-color: #e9eefb !important; }
    #studyCenterTable tbody tr.selected-row { background-color: #d1e7fd !important; font-weight: bold; }

    .clickable-header { cursor: pointer; }
    .clickable-header:hover { color: #444; }

    .align-left { text-align: left !important; }
    .align-center { text-align: center !important; }
    .align-right { text-align: right !important; }

    #log {
      color: navy;
      font-weight: bold;
      margin-top: 14px;
      text-align: center;
      font-size: 1.0rem;
    }

    /* DataTables scroll head inner width fix */
    .dataTables_scrollHeadInner { width: 100% !important; }

    /* responsive adjustments */
    @media (max-width: 1200px) {
      .province-table-wrapper { margin-left: 0; }
      #donutChart { height: 360px !important; }
    }

    @media (max-width: 900px) {
      .header-text h1 { font-size: 1.6rem; }
      .header-text h2 { font-size: 1rem; }
      .cards { flex-direction: column; gap: 8px; }
      .main-visuals { flex-direction: column; }
      .summary-table { min-width: 900px; font-size: 0.8rem; }
      .summary-table thead th { height: 60px; min-height: 60px; font-size: 0.78rem; }
      .summary-table td { padding: 4px; font-size: 0.78rem; }
    }

    /* small tweak to allow datatables header to wrap cleanly */
    table.dataTable thead th { white-space: normal; word-break: break-word; }

    /* utility */
    .nowrap { white-space: nowrap; }
    .muted { color: #666; font-weight: 500; }
  </style>
</head>

<body>
  <div class="dashboard-container scale-control" role="main" aria-label="CDD Women Fund Dashboard">
    <!-- Header -->
    <div class="header" role="banner">
      <div class="header-text" aria-hidden="false">
        <h1><span style="color: navy;">CDD</span><span style="color: deeppink;">Women</span><span style="color: red;">Fund</span></h1>
        <h2><span style="color: #333;">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </span><span style="color: deeppink;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</span></h2>
        <div style="color: navy; font-weight: bold; margin-top: 6px;">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏ï‡∏£‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</div>
      </div>

      <div class="logo-container" aria-hidden="true">
        <!-- logos unchanged as requested -->
        <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD Logo" />
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Additional Logo" />
      </div>
    </div>

    <div class="info-line" aria-live="polite">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568</div>

    <div id="log">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...</div>

    <!-- Cards -->
    <div class="cards" role="region" aria-label="Key KPIs">
      <div class="card pink" role="note" aria-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£">
        <div class="subtitle">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
        <div class="value" id="num-projects">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
        <div class="value" id="approved-money-card1">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568</div>
        <div class="value" id="debt-start-card1">-</div>
      </div>

      <div class="card light-pink" role="note" aria-label="‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
        <div class="subtitle">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)</div>
        <div class="value" id="debt-now-card2">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</div>
        <div class="value" id="recovered-principal">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)</div>
        <div class="value" id="not-due-card2">-</div>
      </div>

      <div class="card orange" role="note" aria-label="‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢">
        <div class="subtitle">‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)</div>
        <div class="value" id="mediation">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏á1)</div>
        <div class="value" id="prosecutor">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á (‡∏á2)</div>
        <div class="value" id="court-filed">-</div>
      </div>

      <div class="card pastel-pink" role="note" aria-label="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢">
        <div class="subtitle">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)</div>
        <div class="value" id="legal-card4">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ</div>
        <div class="value" id="principal-legal">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£</div>
        <div class="value" id="overdue-legal">-</div>
      </div>

      <div class="card deep-pastel-pink" role="note" aria-label="‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î">
        <div class="subtitle">‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)</div>
        <div class="value" id="overdue-card5">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</div>
        <div class="value" id="percent-overdue-card5">-</div>
        <div style="height:8px"></div>
        <div class="subtitle">‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 5 ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î</div>
        <div class="value" id="over-5-percent">-</div>
      </div>
    </div>

    <!-- visuals -->
    <div class="main-visuals" role="region" aria-label="Charts and visuals">
      <div class="left">
        <div class="section-title">10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
        <canvas id="donutChart" aria-label="Donut chart showing top overdue percentage" role="img"></canvas>
      </div>

      <div class="center" aria-hidden="false">
        <img src="https://i.postimg.cc/pTR4HCg3/women5-copy.png" alt="‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á" />
      </div>
    </div>

    <!-- province table -->
    <div class="province-table-wrapper" role="region" aria-label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
      <table class="summary-table" id="provinceTable" style="width:100%;">
        <thead>
          <!-- dynamic -->
        </thead>
        <tbody>
          <!-- dynamic -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
  /* ================================
     Dashboard JS (complete, ready-to-run)
     - Fetches from provided Apps Script URL
     - Renders cards, donut chart, and province table
     - Translates column keys to Thai using columnMap
     - Forces table header to be two lines by CSS height (70px)
     - Keeps logos, colors, layout unchanged
     ================================ */

  const API_URL = "https://script.google.com/macros/s/AKfycbzMxEWPAJZ_6T8kUxQPGdsvbuFya-M9rpq_bIybdsQztHbfO49roTju3ABGUrp3nJcQWQ/exec";
  let donutChartInstance = null;
  let provinceDataTable = null;

  /* mapping key -> ‡πÑ‡∏ó‡∏¢ */
  const columnMap = {
    province: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
    totalProjects: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    approvedAmount: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    debtStart: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568",
    debtNow: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)",
    notDue: "‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)",
    recoveredPrincipal: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô",
    recoveredInterest: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢",
    recoveredFine: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏±‡∏ö",
    recoveredPenaltyInterest: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î",
    recoveredOverpay: "‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô",
    recoveredTotal: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ß‡∏°",
    debtAsOf30968: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 30 ‡∏Å.‡∏¢. 2568",
    mediation: "‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)",
    prosecutor: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏á1)",
    courtFiled: "‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á (‡∏á2)",
    courtJudgement: "‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (‡∏á3)",
    courtConsent: "‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏° (‡∏á4)",
    civilLaw20: "‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°.20 ‡∏ï‡∏£‡∏µ (‡∏á5)",
    criminalAction: "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤ (‡∏á6)",
    legalAction: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)",
    principalLegal: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ",
    overdueLegal: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£",
    overdue: "‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)",
    overduePercent: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (C)",
    contractEndDebt: "‡∏à‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (D)",
    over5Percent: "‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 5 ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î (E)",
    statusPayment: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ",
    projectStatus: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    notes: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
  };

  /* desired column order; missing keys will be appended after these */
  const orderedColumns = [
    "province","totalProjects","approvedAmount",
    "debtStart","debtNow","notDue","recoveredPrincipal",
    "recoveredInterest","recoveredFine","recoveredPenaltyInterest","recoveredOverpay","recoveredTotal","debtAsOf30968",
    "mediation","prosecutor","courtFiled","courtJudgement","courtConsent","civilLaw20","criminalAction",
    "legalAction","principalLegal","overdueLegal","overdue","overduePercent",
    "contractEndDebt","over5Percent","statusPayment","projectStatus","notes"
  ];

  /* formatting helpers */
  function formatNumber(num) {
    if (num === null || num === undefined || String(num).trim() === "") return "-";
    const n = Number(String(num).replace(/[^0-9.-]/g, ''));
    if (!isFinite(n)) return String(num);
    return n.toLocaleString('th-TH');
  }
  function formatPercent(val) {
    const n = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
    return isNaN(n) ? "-" : n.toFixed(2) + "%";
  }

  async function fetchData() {
    const logEl = document.getElementById('log');
    logEl.textContent = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...";
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ');
      const data = await res.json();
      if (data.error) {
        console.error('Apps Script Error:', data.error);
        logEl.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Apps Script error)";
        return;
      }

      const overview = data.overview || {};
      const pieChartData = data.topOverdue || [];
      const provinces = data.provinces || [];

      // update cards
      document.getElementById('num-projects').textContent = formatNumber(overview.B2);
      document.getElementById('approved-money-card1').textContent = formatNumber(overview.C2);
      document.getElementById('debt-start-card1').textContent = formatNumber(overview.D2);
      document.getElementById('debt-now-card2').textContent = formatNumber(overview.E2);
      document.getElementById('recovered-principal').textContent = formatNumber(overview.G2);
      document.getElementById('not-due-card2').textContent = formatNumber(overview.F2);
      document.getElementById('mediation').textContent = formatNumber(overview.H2);
      document.getElementById('prosecutor').textContent = formatNumber(overview.I2);
      document.getElementById('court-filed').textContent = formatNumber(overview.J2);
      document.getElementById('court-judgement').textContent = formatNumber(overview.K2);
      document.getElementById('court-consent').textContent = formatNumber(overview.L2);
      document.getElementById('civil-law-20').textContent = formatNumber(overview.M2);
      document.getElementById('criminal-action').textContent = formatNumber(overview.N2);
      document.getElementById('legal-card4').textContent = formatNumber(overview.O2);
      document.getElementById('principal-legal').textContent = formatNumber(overview.P2);
      document.getElementById('overdue-legal').textContent = formatNumber(overview.Q2);
      document.getElementById('overdue-card5').textContent = formatNumber(overview.R2);
      document.getElementById('percent-overdue-card5').textContent = formatPercent(overview.S2);
      document.getElementById('contract-end-debt').textContent = formatNumber(overview.T2);
      document.getElementById('over-5-percent').textContent = formatPercent(overview.U2);

      // donut chart
      if (donutChartInstance) donutChartInstance.destroy();
      const ctx = document.getElementById('donutChart').getContext('2d');
      donutChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: pieChartData.map(p => p.province),
          datasets: [{
            data: pieChartData.map(p => parseFloat(p.percent) || 0),
            backgroundColor: ['#FF202B','#87FEBC','#FFB6B7','#FFDD63','#F68B71','#DAB9E6','#A0E8E8','#ADFF2F','#FFFF00','#FFA500']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const label = ctx.label || '';
                  const value = (parseFloat(ctx.raw) || 0).toFixed(2);
                  return `${label}: ${value}%`;
                }
              }
            }
          }
        }
      });

      // table rendering
      const table = document.getElementById('provinceTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';

      if (!provinces || provinces.length === 0) {
        thead.innerHTML = '<tr><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th></tr>';
        logEl.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î';
        return;
      }

      // determine columns: use orderedColumns as base, append any extra keys from data
      const responseKeys = Object.keys(provinces[0] || {});
      const orderedPresent = orderedColumns.filter(k => responseKeys.includes(k));
      const remaining = responseKeys.filter(k => !orderedPresent.includes(k));
      const finalColumns = [...orderedPresent, ...remaining];

      // build header HTML using columnMap for Thai labels
      const headerHtml = finalColumns.map(k => {
        const label = columnMap[k] || k;
        // wrap label with <div> to allow nicer line-break control; CSS limits height
        return `<th><div style="display:block;width:100%;">${label}</div></th>`;
      }).join('');
      thead.innerHTML = `<tr>${headerHtml}</tr>`;

      // populate rows
      provinces.forEach(rowObj => {
        const url = `https://tnah097.github.io/cdwomenpod-dashboard/province.html?province=${encodeURIComponent(rowObj.province || '')}`;
        const rowHtml = finalColumns.map(k => {
          const raw = rowObj[k];
          if (k === 'province') {
            const disp = (raw === null || raw === undefined || raw === '') ? '-' : raw;
            return `<td class="align-left"><a class="province-link" target="_blank" href="${url}">${disp}</a></td>`;
          }
          if (k === 'overduePercent' || String(k).toLowerCase().includes('percent')) {
            return `<td class="align-right">${formatPercent(raw)}</td>`;
          }
          if (raw === null || raw === undefined || raw === '') return `<td class="align-right">-</td>`;
          const numericCandidate = Number(String(raw).replace(/[^0-9.-]/g, ''));
          if (isFinite(numericCandidate)) {
            return `<td class="align-right">${formatNumber(numericCandidate)}</td>`;
          } else {
            // text/string
            return `<td class="align-right">${String(raw)}</td>`;
          }
        }).join('');
        tbody.insertAdjacentHTML('beforeend', `<tr>${rowHtml}</tr>`);
      });

      // initialize DataTable with horizontal scroll
      if ($.fn.DataTable.isDataTable('#provinceTable')) {
        $('#provinceTable').DataTable().clear().destroy();
      }

      provinceDataTable = $('#provinceTable').DataTable({
        paging: false,
        searching: true,
        scrollX: true,
        scrollY: '420px',
        scrollCollapse: true,
        order: [],
        language: { search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" },
        initComplete: function() {
          // adjust columns so header alignment is correct
          this.api().columns.adjust();
        }
      });

      // small delay to ensure datatables header sizing correct
      setTimeout(() => {
        if (provinceDataTable && provinceDataTable.columns) provinceDataTable.columns.adjust().draw(false);
      }, 260);

      logEl.textContent = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    } catch (err) {
      console.error(err);
      document.getElementById('log').textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    }
  }

  // initial fetch
  fetchData();

  // optional: poll for changes (auto-refresh) ‚Äî user requested "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
  // Note: polling every 90 seconds (adjust as needed). This is client-side auto-refresh.
  // If you prefer server push or caching, modify Apps Script to create JSON cache.
  (function autoRefresh() {
    // run every 90s to reflect sheet changes automatically
    const INTERVAL_MS = 90000;
    setInterval(() => {
      // silently fetch and re-render
      fetchData();
    }, INTERVAL_MS);
  })();

  </script>
</body>
</html>
