<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CDDWomenfund Dashboard ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ô (Realtime Polling 5s)</title>

  <!-- Libraries (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />

  <!--
    ======= NOTES =======
    - ‡πÇ‡∏Ñ‡πâ‡∏î‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ" ‚Äî ‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .html ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
    - Polling (Realtime ‡∏à‡∏≥‡∏•‡∏≠‡∏á) ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô 5000 ms (5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    - ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡∏™‡∏π‡∏á ~70px (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
    - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÅ‡∏ñ‡∏ß (nowrap + ellipsis)
    - ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ, ‡∏™‡∏µ, layout ‡∏´‡∏•‡∏±‡∏Å ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    - ‡πÉ‡∏ä‡πâ Apps Script API URL ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏≤ (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ API_URL ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á JSON
    ======================
  -->

  <style>
    /* ========= Theme (pastel pink-purple) ========= */
    :root{
      --pink-1:#ffe6f0;
      --pink-2:#f3e5f5;
      --pink-3:#e1bee7;
      --card-pink:#e91e63;
      --card-light-pink:#f8bbd0;
      --accent:#f06292;
      --border:#f8bbd0;
      --text-dark:#111;
    }
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family: "Sarabun", Arial, sans-serif;
      background: linear-gradient(135deg,var(--pink-1) 0%, var(--pink-2) 50%, var(--pink-3) 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      margin:0;
      color:var(--text-dark);
    }

    /* container */
    .dashboard-container{
      max-width:1500px;
      margin:16px auto;
      background: rgba(255,255,255,0.94);
      border-radius:14px;
      padding:22px 22px 36px 22px;
      box-shadow:0 8px 28px rgba(0,0,0,0.08);
      min-height:calc(100vh - 48px);
      box-sizing:border-box;
    }

    /* header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .header-text{display:flex;flex-direction:column}
    h1{margin:0;font-size:2.3rem;line-height:1}
    h2{margin:4px 0 0 0;font-size:1.05rem;color:#333;line-height:1}
    .logo-container{display:flex;align-items:center;gap:12px}
    .logo-container img{height:60px}

    .info-line{
      color:navy;font-weight:700;text-align:right;margin-top:8px;font-size:0.95rem;
    }

    /* cards */
    .cards{display:flex;gap:14px;margin-top:18px;flex-wrap:wrap}
    .card{
      border-radius:10px;padding:12px 12px;min-width:210px;box-sizing:border-box;color:#000;font-weight:700;
      display:flex;flex-direction:column;
    }
    .card .subtitle{font-size:0.95rem;margin:4px 0 0 0;color:#000;font-weight:700}
    .card .value{font-size:1.5rem;margin-top:6px;color:#000;font-weight:600;white-space:nowrap}
    .card.pink{background:linear-gradient(180deg,var(--card-pink),#d81b60);color:#fff}
    .card.light-pink{background:linear-gradient(180deg,var(--card-light-pink),#f3a9c6);color:#000}
    .card.orange{background:linear-gradient(180deg,#ff9800,#ffb24d);color:#000}
    .card.pastel-pink{background:linear-gradient(180deg,#fce4ec,#f6cfe0);color:#000}
    .card.deep-pastel-pink{background:linear-gradient(180deg,#f06292,#ec6790);color:#fff}

    /* visuals */
    .main-visuals{display:flex;gap:16px;align-items:flex-start;margin-top:20px;flex-wrap:wrap}
    .left,.center{flex:1;min-width:300px}
    .center img{max-width:100%;width:320px;display:block;margin:0 auto}

    /* donut chart size */
    #donutChart{width:100%!important;height:420px!important;max-height:520px}

    .section-title{text-align:center;font-weight:700;margin-bottom:6px}

    /* table wrapper */
    .province-table-wrapper{margin-top:18px;overflow:hidden}

    /* summary table base */
    .summary-table{
      width:100%!important;border-collapse:separate;border-spacing:0;font-size:0.88rem;color:var(--text-dark);
      table-layout:fixed;min-width:1100px;
    }

    /*
      IMPORTANT: header must be two lines tall (~70px), center aligned both vertically & horizontally,
      and wrap automatically to form two lines when necessary.
    */
    .summary-table thead th{
      background-color:var(--accent);
      color:#000;
      padding:10px;
      border:1px solid var(--border);
      font-weight:700;
      text-align:center;
      vertical-align:middle;
      white-space:normal;         /* allow wrapping */
      word-break:break-word;
      line-height:1.15;
      height:70px;                /* fixed height to be two lines */
      min-height:70px;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
      padding-left:8px;
      padding-right:8px;
    }

    /* Wrap container inside th for nicer hyphenation/line break control */
    .summary-table thead th .th-wrap{
      display:block;
      width:100%;
      text-align:center;
      line-height:1.15;
      max-height:calc(2 * 1.15em); /* approx two lines */
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }

    /* data cells ‚Äî numeric single line */
    .summary-table td{
      padding:8px 10px;border:1px solid var(--border);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle;
      color:var(--text-dark);
    }

    .summary-table tr:nth-child(even){background:#fce4ec}
    .summary-table tr:nth-child(odd){background:#fff}

    .province-link{color:#0645AD;text-decoration:underline;cursor:pointer}
    .province-link:hover{color:#042a66}

    /* DataTables and responsiveness */
    .dataTables_scrollHeadInner{width:100%!important}
    table.dataTable thead th{white-space:normal;word-break:break-word}

    @media (max-width:1200px){
      #donutChart{height:360px!important}
      .summary-table{min-width:900px}
      .summary-table thead th{height:64px;min-height:64px}
    }
    @media (max-width:900px){
      .header h1{font-size:1.5rem}
      .header h2{font-size:1rem}
      .cards{flex-direction:column}
      .main-visuals{flex-direction:column}
      .summary-table{min-width:740px;font-size:0.78rem}
      .summary-table thead th{height:60px;min-height:60px}
      .summary-table td{padding:6px;font-size:0.78rem}
      #donutChart{height:320px!important}
    }

    /* small helper classes */
    .align-left{text-align:left!important}
    .align-right{text-align:right!important}
    .align-center{text-align:center!important}
    #log{color:navy;font-weight:700;text-align:center;margin-top:10px;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="dashboard-container" role="main" aria-label="CDD Women Fund Dashboard">
    <!-- header -->
    <div class="header" role="banner">
      <div class="header-text" role="heading" aria-level="1">
        <h1><span style="color:navy">CDD</span><span style="color:deeppink">Women</span><span style="color:red">Fund</span></h1>
        <h2><span>‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span> <span style="color:deeppink">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</span></h2>
        <div style="margin-top:8px;font-weight:700;color:navy">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏ï‡∏£‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</div>
      </div>

      <div class="logo-container" aria-hidden="true">
        <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD Logo" />
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Women Fund Logo" />
      </div>
    </div>

    <div class="info-line" aria-live="polite">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568</div>
    <div id="log">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...</div>

    <!-- KPI cards -->
    <div class="cards" role="region" aria-label="Key KPIs">
      <div class="card pink" role="note">
        <div class="subtitle">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
        <div class="value" id="num-projects">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
        <div class="value" id="approved-money-card1">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568</div>
        <div class="value" id="debt-start-card1">-</div>
      </div>

      <div class="card light-pink" role="note">
        <div class="subtitle">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)</div>
        <div class="value" id="debt-now-card2">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</div>
        <div class="value" id="recovered-principal">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)</div>
        <div class="value" id="not-due-card2">-</div>
      </div>

      <div class="card orange" role="note">
        <div class="subtitle">‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)</div>
        <div class="value" id="mediation">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏á1)</div>
        <div class="value" id="prosecutor">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á (‡∏á2)</div>
        <div class="value" id="court-filed">-</div>
      </div>

      <div class="card pastel-pink" role="note">
        <div class="subtitle">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)</div>
        <div class="value" id="legal-card4">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ</div>
        <div class="value" id="principal-legal">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£</div>
        <div class="value" id="overdue-legal">-</div>
      </div>

      <div class="card deep-pastel-pink" role="note">
        <div class="subtitle">‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)</div>
        <div class="value" id="overdue-card5">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</div>
        <div class="value" id="percent-overdue-card5">-</div>

        <div style="height:6px"></div>
        <div class="subtitle">‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 5 ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î</div>
        <div class="value" id="over-5-percent">-</div>
      </div>
    </div>

    <!-- visuals -->
    <div class="main-visuals" role="region" aria-label="Charts">
      <div class="left" aria-hidden="false">
        <div class="section-title">10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
        <canvas id="donutChart" role="img" aria-label="Donut chart"></canvas>
      </div>

      <div class="center" aria-hidden="false">
        <img src="https://i.postimg.cc/pTR4HCg3/women5-copy.png" alt="‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á" />
      </div>
    </div>

    <!-- province table -->
    <div class="province-table-wrapper" role="region" aria-label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
      <table class="summary-table" id="provinceTable" aria-describedby="log" role="table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- =========================
       JAVASCRIPT: Dashboard logic
       - Polling every 5 seconds (real-time simulation)
       - Column mapping to Thai (two-line headers)
       - Numeric formatting, single-line numeric cells
       - DataTables integration
       ========================= -->
  <script>
    // ---------- CONFIG ----------
    const API_URL = "https://script.google.com/macros/s/AKfycbzMxEWPAJZ_6T8kUxQPGdsvbuFya-M9rpq_bIybdsQztHbfO49roTju3ABGUrp3nJcQWQ/exec";
    const POLLING_INTERVAL_MS = 5000; // 5 seconds (user requested realtime simulation)

    // Column mapping (English key -> Thai label)
    const columnMap = {
      province: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
      totalProjects: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
      approvedAmount: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
      debtStart: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568",
      debtNow: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)",
      notDue: "‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)",
      recoveredPrincipal: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô",
      recoveredInterest: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢",
      recoveredFine: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏±‡∏ö",
      recoveredPenaltyInterest: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î",
      recoveredOverpay: "‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô",
      recoveredTotal: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ß‡∏°",
      debtAsOf30968: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 30 ‡∏Å.‡∏¢. 2568",
      mediation: "‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)",
      prosecutor: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏á1)",
      courtFiled: "‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á (‡∏á2)",
      courtJudgement: "‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (‡∏á3)",
      courtConsent: "‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏° (‡∏á4)",
      civilLaw20: "‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°.20 ‡∏ï‡∏£‡∏µ (‡∏á5)",
      criminalAction: "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤ (‡∏á6)",
      legalAction: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)",
      principalLegal: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ",
      overdueLegal: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£",
      overdue: "‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)",
      overduePercent: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (C)",
      contractEndDebt: "‡∏à‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (D)",
      over5Percent: "‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 5 ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î (E)",
      statusPayment: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ",
      projectStatus: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
      notes: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
    };

    // Desired column order (keys). Any keys returned by API but not in this list will be appended.
    const orderedColumns = [
      "province","totalProjects","approvedAmount",
      "debtStart","debtNow","notDue","recoveredPrincipal",
      "recoveredInterest","recoveredFine","recoveredPenaltyInterest","recoveredOverpay","recoveredTotal","debtAsOf30968",
      "mediation","prosecutor","courtFiled","courtJudgement","courtConsent","civilLaw20","criminalAction",
      "legalAction","principalLegal","overdueLegal","overdue","overduePercent",
      "contractEndDebt","over5Percent","statusPayment","projectStatus","notes"
    ];

    // Chart and DataTable instances
    let donutChartInstance = null;
    let provinceDataTable = null;

    // ---------- helpers ----------
    function formatNumber(num){
      if (num === null || num === undefined || String(num).trim() === "") return "-";
      // Remove any non-numeric except minus and dot
      const cleaned = String(num).replace(/[^0-9.-]/g,'');
      const n = Number(cleaned);
      if (!isFinite(n)) return String(num);
      return n.toLocaleString('th-TH');
    }

    function formatPercent(val){
      if (val === null || val === undefined || String(val).trim() === "") return "-";
      const cleaned = String(val).replace(/[^0-9.-]/g,'');
      const n = parseFloat(cleaned);
      if (isNaN(n)) return String(val);
      return n.toFixed(2) + "%";
    }

    function clearElement(el){
      while(el.firstChild) el.removeChild(el.firstChild);
    }

    // Build header cell (wrap text into 2-line container)
    function buildHeaderCell(label){
      // create th element with inner div .th-wrap for two-line clamp
      const th = document.createElement('th');
      const wrap = document.createElement('div');
      wrap.className = 'th-wrap';
      wrap.textContent = label;
      th.appendChild(wrap);
      return th;
    }

    // ---------- main fetch & render ----------
    async function fetchAndRender(){
      const logEl = document.getElementById('log');
      logEl.textContent = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...";
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏î‡πâ (HTTP ' + res.status + ')');
        const json = await res.json();

        if (json.error){
          console.error('Apps Script error:', json.error);
          logEl.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Apps Script)"; 
          return;
        }

        // expected keys: overview, provinces (array), topOverdue (array)
        const overview = json.overview || {};
        const provinces = json.provinces || [];
        const pieData = json.topOverdue || [];

        // update KPI cards (overview uses exact keys B2/C2 etc as in Apps Script)
        document.getElementById('num-projects').textContent = formatNumber(overview.B2);
        document.getElementById('approved-money-card1').textContent = formatNumber(overview.C2);
        document.getElementById('debt-start-card1').textContent = formatNumber(overview.D2);
        document.getElementById('debt-now-card2').textContent = formatNumber(overview.E2);
        document.getElementById('recovered-principal').textContent = formatNumber(overview.G2);
        document.getElementById('not-due-card2').textContent = formatNumber(overview.F2);
        document.getElementById('mediation').textContent = formatNumber(overview.H2);
        document.getElementById('prosecutor').textContent = formatNumber(overview.I2);
        document.getElementById('court-filed').textContent = formatNumber(overview.J2);
        document.getElementById('court-judgement').textContent = formatNumber(overview.K2);
        document.getElementById('court-consent').textContent = formatNumber(overview.L2);
        document.getElementById('civil-law-20').textContent = formatNumber(overview.M2);
        document.getElementById('criminal-action').textContent = formatNumber(overview.N2);
        document.getElementById('legal-card4').textContent = formatNumber(overview.O2);
        document.getElementById('principal-legal').textContent = formatNumber(overview.P2);
        document.getElementById('overdue-legal').textContent = formatNumber(overview.Q2);
        document.getElementById('overdue-card5').textContent = formatNumber(overview.R2);
        document.getElementById('percent-overdue-card5').textContent = formatPercent(overview.S2);
        document.getElementById('contract-end-debt').textContent = formatNumber(overview.T2);
        document.getElementById('over-5-percent').textContent = formatPercent(overview.U2);

        // ---------- Donut chart ----------
        if (donutChartInstance){
          try{ donutChartInstance.destroy(); }catch(e){/* ignore */ }
          donutChartInstance = null;
        }
        const ctx = document.getElementById('donutChart').getContext('2d');
        const colors = ['#FF202B','#87FEBC','#FFB6B7','#FFDD63','#F68B71','#DAB9E6','#A0E8E8','#ADFF2F','#FFFF00','#FFA500'];
        donutChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: pieData.map(p => p.province || '-'),
            datasets: [{
              data: pieData.map(p => parseFloat(String(p.percent || 0).replace(/[^0-9.-]/g,'')) || 0),
              backgroundColor: colors
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(context){
                    const label = context.label || '';
                    const raw = context.raw || 0;
                    const val = (parseFloat(raw) || 0).toFixed(2);
                    return label + ': ' + val + '%';
                  }
                }
              }
            }
          }
        });

        // ---------- Table rendering ----------
        const table = document.getElementById('provinceTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');

        // clear
        clearElement(thead);
        clearElement(tbody);

        if (!Array.isArray(provinces) || provinces.length === 0){
          const tr = document.createElement('tr');
          const th = document.createElement('th');
          const wrap = document.createElement('div');
          wrap.className = 'th-wrap';
          wrap.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          th.appendChild(wrap);
          tr.appendChild(th);
          thead.appendChild(tr);
          logEl.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î';
        } else {
          // determine keys (columns)
          const responseKeys = Object.keys(provinces[0] || {});
          const orderedPresent = orderedColumns.filter(k => responseKeys.includes(k));
          const remaining = responseKeys.filter(k => !orderedPresent.includes(k));
          const finalColumns = [...orderedPresent, ...remaining];

          // build thead
          const headRow = document.createElement('tr');
          finalColumns.forEach(k => {
            const label = columnMap[k] || k;
            const th = buildHeaderCell(label);
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);

          // build rows
          provinces.forEach(rowObj => {
            const tr = document.createElement('tr');

            finalColumns.forEach(k => {
              const td = document.createElement('td');
              td.className = (k === 'province') ? 'align-left' : 'align-right';
              let raw = rowObj[k];

              // province -> link
              if (k === 'province') {
                const link = document.createElement('a');
                link.className = 'province-link';
                link.target = '_blank';
                // link to the user's province page (keeps existing behavior)
                link.href = 'https://tnah097.github.io/cdwomenpod-dashboard/province.html?province=' + encodeURIComponent(raw || '');
                link.textContent = (raw === null || raw === undefined || raw === '') ? '-' : String(raw);
                td.appendChild(link);
                tr.appendChild(td);
                return;
              }

              // percentage columns
              if (String(k).toLowerCase().includes('percent') || k === 'overduePercent') {
                td.textContent = formatPercent(raw);
                tr.appendChild(td);
                return;
              }

              // numbers -> format, ensure one-line
              if (raw === null || raw === undefined || String(raw).trim() === '') {
                td.textContent = '-';
                tr.appendChild(td);
                return;
              }
              const cleaned = String(raw).replace(/[^0-9.-]/g,'');
              const numericCandidate = Number(cleaned);
              if (isFinite(numericCandidate)) {
                td.textContent = formatNumber(numericCandidate);
              } else {
                // not numeric, show as-is but keep in single line
                td.textContent = String(raw);
              }
              tr.appendChild(td);
            });

            tbody.appendChild(tr);
          });

          // initialize/refresh DataTable
          // destroy previous instance if exists
          if ($.fn.DataTable.isDataTable('#provinceTable')) {
            try {
              $('#provinceTable').DataTable().clear().destroy();
            } catch(e){
              // swallow
            }
          }

          // init DataTable with horizontal scroll and fixed header height preserved
          provinceDataTable = $('#provinceTable').DataTable({
            paging: false,
            searching: true,
            scrollX: true,
            scrollY: '420px',
            scrollCollapse: true,
            order: [],
            language: { search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" },
            initComplete: function(){
              try { this.api().columns.adjust(); } catch(e) {}
            }
          });

          // small delay to re-adjust columns (fix header misalignment)
          setTimeout(function(){
            try { if (provinceDataTable && provinceDataTable.columns) provinceDataTable.columns.adjust().draw(false); } catch(e){}
          }, 200);

          logEl.textContent = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('log').textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      }
    } // end fetchAndRender

    // ---------- Start polling ----------
    (function startPolling(){
      // initial
      fetchAndRender();

      // Polling every POLLING_INTERVAL_MS milliseconds
      setInterval(function(){
        fetchAndRender();
      }, POLLING_INTERVAL_MS);
    })();

    // ---------- Accessibility & small UX ----------
    // allow pressing '/' to focus the DataTables search box (if exists)
    document.addEventListener('keydown', function(e){
      if (e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey) {
        const search = document.querySelector('#provinceTable_filter input');
        if (search) {
          e.preventDefault();
          search.focus();
          search.select();
        }
      }
    });

    // Ensure charts resize when window changes
    window.addEventListener('resize', function(){
      if (donutChartInstance) donutChartInstance.resize();
      if (provinceDataTable && provinceDataTable.columns) {
        try { provinceDataTable.columns.adjust().draw(false); } catch(e){}
      }
    });

  </script>
</body>
</html>
