
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏ï‡∏£‡∏µ</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Sarabun', sans-serif;
  margin: 0;
  padding: 20px;
  background: linear-gradient(to bottom right, #ffe6f0, #ffd1e6);
  display: flex;
  justify-content: center;
  min-height: 100vh;
}
.container {
  width: 100%;
  max-width: 1400px;
  background: rgba(255,255,255,0.95);
  border-radius: 25px;
  padding: 30px;
  box-shadow: 0 8px 25px rgba(233, 30, 99, 0.25);
  position: relative;
}
.logos-top {
  position: absolute;
  top: 20px;
  right: 20px;
  display: flex;
  gap: 10px;
}
.logos-top img { height: 55px; }

.header-block {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
#reportInfo {
  flex: 1;
  text-align: center;
  color: #880e4f;
  font-weight: bold;
  margin-top: 40px;
  line-height: 1.6em;
}
#reportDate {
  flex-basis: 100%;
  text-align: right;
  color: #880e4f;
  font-weight: bold;
  font-size: 0.95rem;
  margin-top: 5px;
}

/* toolbar */
.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.left-tools {
  display: flex;
  align-items: center;
  gap: 10px;
}
.left-tools button {
  background-color: #f8bbd0;
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  color: #880e4f;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: 0.2s;
}
.left-tools button:hover { background-color: #f48fb1; }
.left-tools img { height: 18px; }

.filter-bar {
  display: flex;
  align-items: center;
  gap: 8px;
}
.filter-bar select, .filter-bar input {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #f48fb1;
  font-family: 'Sarabun';
  font-size: 0.9rem;
}
#downloadBtn {
  background-color: #f8bbd0;
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  color: #880e4f;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}
#downloadBtn:hover { background-color: #f48fb1; }

/* table */
.table-wrapper {
  overflow: auto;
  max-height: 80vh;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(233,30,99,0.1);
  background: white;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}
th, td {
  border: 1px solid #c97a9b;
  padding: 6px 8px;
  text-align: center;
  vertical-align: middle;
  white-space: nowrap;
}
thead th {
  background-color: #f8bbd0;
  color: #880e4f;
  font-weight: 700;
  border: 1.5px solid #b36a84;
  z-index: 5;
}
thead tr:nth-child(1) th { position: sticky; top: 0; }
thead tr:nth-child(2) th { position: sticky; top: 32px; }

  
thead tr:last-child th { border-bottom: 2.5px solid #880e4f; }
tr:nth-child(even) td { background-color: rgba(255,182,193,0.12); }
tr:nth-child(odd) td { background-color: rgba(255,192,203,0.05); }
.empty-row td {
  text-align: center;
  padding: 15px;
  font-style: italic;
  color: #c62828;
}

/* search + icons */
.search-wrap { display:flex; gap:10px; align-items:center; }
.icon-small { width:20px; height:20px; display:inline-block; }
</style>
</head>

<body>
<div class="container">
  <div class="logos-top">
    <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD Logo" />
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Women Fund Logo" />
  </div>

  <div class="header-block">
    <div id="reportInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</div>
    <div id="reportDate"></div>
  </div>

  <!-- toolbar -->
  <div class="toolbar">
    <!-- <div class="left-tools">
      <button onclick="window.location.href='Menu.html'">
        <img src="https://cdn-icons-png.flaticon.com/512/25/25694.png" alt="home"> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
      </button>
    </div> -->

    <div class="filter-bar">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <select id="sheetSelect" onchange="onSheetChange()">
        <option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
      </select>

      <div class="search-wrap">
        üîç <input type="text" id="filterInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
      </div>

      <button id="downloadBtn" onclick="downloadExcel()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="dataTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody">
        <tr class="empty-row"><td colspan="30">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/*
  IMPORTANT:
  - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ API_URL ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏ó‡∏µ‡πà Deploy ‡∏à‡∏≤‡∏Å Apps Script (Code.gs) ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: const API_URL = 'https://script.google.com/macros/s/AKfycb.../exec';
*/
const API_URL = 'https://script.google.com/macros/s/AKfycbwlH8Smpn_snzR7K8RTURfMxNpg7l-ucuRGwDeMRKl-zvRElclqX6ywt_8ZqkIbXxGO/exec'; // <-- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

let currentSheet = '';
const START_HEADER_ROW = 3;  // Header 1
const END_HEADER_ROW = 4;    // Header 2
const START_BODY_ROW = 5;    // Data row
  
// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
async function loadSheetList() {
  try {
    const res = await fetch(`${API_URL}?action=listSheets`);
    const json = await res.json();
    if (json.error) throw new Error(json.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡πÑ‡∏î‡πâ');
    const sel = document.getElementById('sheetSelect');
    sel.innerHTML = '';
    json.sheets.forEach((name, idx) => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
      if (idx === 0) currentSheet = name;
    });
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô sheet ‡πÅ‡∏£‡∏Å (‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ default)
    if (!currentSheet && json.sheets.length) currentSheet = json.sheets[0];
    // ‡πÇ‡∏´‡∏•‡∏î sheet ‡πÅ‡∏£‡∏Å
    if (currentSheet) loadSheet(currentSheet);
  } catch (err) {
    console.error(err);
    document.getElementById('reportInfo').textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏µ‡∏ï';
  }
}

function onSheetChange() {
  const sel = document.getElementById('sheetSelect');
  currentSheet = sel.value;
  loadSheet(currentSheet);
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sheet ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
async function loadSheet(sheetName) {
  const infoEl = document.getElementById('reportInfo');
  const dateEl = document.getElementById('reportDate');
  const thead = document.getElementById('tableHead');
  const tbody = document.getElementById('tableBody');

  infoEl.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...';
  thead.innerHTML = '';
  tbody.innerHTML = `<tr class="empty-row"><td colspan="30">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;

  try {
    const res = await fetch(`${API_URL}?sheetName=${encodeURIComponent(sheetName)}`);
    const json = await res.json();
    if (json.error) throw new Error(json.error);

    const { data, merged } = json;
    if (!data || !data.length) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï');

    // ‡∏™‡πà‡∏ß‡∏ô header ‡∏ö‡∏ô‡∏™‡∏∏‡∏î (‡∏ô‡∏≥ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
    const topHeaderRows = data.slice(0, START_HEADER_ROW);
    infoEl.innerHTML = topHeaderRows.map(r => r.join(' ')).slice(0,2).join('<br>');
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 3 ‡πÉ‡∏ô sheet ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    dateEl.textContent = data[2] ? data[2].join(' ').trim() : '';

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° header table (‡πÅ‡∏ñ‡∏ß START_HEADER_ROW .. END_HEADER_ROW)
    const headerRows = data.slice(START_HEADER_ROW, END_HEADER_ROW + 1);
   const headerMerged = merged.filter(m =>
  m.row >= START_HEADER_ROW && m.row <= END_HEADER_ROW
).map(m => ({
  row: m.row - START_HEADER_ROW,
  col: m.col,
  width: m.width,
  height: m.height
}));

    thead.innerHTML = applyMergedCells(headerRows, headerMerged, true);

    // body (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà START_BODY_ROW ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ)
    const bodyRows = data.slice(START_BODY_ROW);
    renderTableBody(bodyRows);

    // update theme color - ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ sheet (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏è‡∏™‡∏µ‡πÑ‡∏î‡πâ)
    updateThemeColorBySheet(sheetName);

  } catch (err) {
    console.error(err);
    infoEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
    tbody.innerHTML = `<tr class="empty-row"><td colspan="30">‚ùå ${err.message}</td></tr>`;
  }
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á thead / tbody ‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö merged cells
// isHeader: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô true ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á <th> ‡πÅ‡∏ó‡∏ô <td>
function applyMergedCells(cellData, mergedInfo, isHeader=false) {
  if (!cellData || cellData.length === 0) return '';
  const rows = cellData.length;
  const cols = cellData[0].length;
  const hidden = Array(rows).fill(0).map(()=>Array(cols).fill(false));
  let html = '';
  const tag = isHeader ? 'th' : 'td';

  for (let r=0; r<rows; r++) {
    html += '<tr>';
    for (let c=0; c<cols; c++) {
      if (hidden[r][c]) continue;
      const m = mergedInfo.find(mm => mm.row === r && mm.col === c);
      let attr = '';
      if (m && (m.height>1 || m.width>1)) {
        attr += ` rowspan="${m.height}" colspan="${m.width}"`;
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        for (let i=0;i<m.height;i++){
          for (let j=0;j<m.width;j++){
            if (i===0 && j===0) continue;
            if (r+i < rows && c+j < cols) hidden[r+i][c+j] = true;
          }
        }
      }
      const cellVal = (cellData[r][c] !== undefined && cellData[r][c] !== null) ? cellData[r][c] : '';
      html += `<${tag}${attr}>${cellVal}</${tag}>`;
    }
    html += '</tr>';
  }
  return html;
}

// render body rows (‡πÑ‡∏°‡πà‡∏°‡∏µ merged cell ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö body ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)
function renderTableBody(rows) {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  rows.forEach(row => {
    let tr = '<tr>';
    row.forEach(cell => {
      const value = (typeof cell === 'number') ? cell.toLocaleString('th-TH') : (cell || '');
      tr += `<td>${value}</td>`;
    });
    tr += '</tr>';
    tbody.innerHTML += tr;
  });
}

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÇ‡∏î‡∏¢‡∏á‡πà‡∏≤‡∏¢: sheet name contains '68' -> pink, if contains '69' and wants purple etc.
// ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏é‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
function updateThemeColorBySheet(sheetName) {
  const ths = document.querySelectorAll("thead th");
  const header = document.getElementById("reportInfo");
  const date = document.getElementById("reportDate");
  const downloadBtn = document.getElementById("downloadBtn");
  // default pink
  let mainColor = "#f8bbd0", darkColor = "#880e4f", bg = "linear-gradient(to bottom right, #ffe6f0, #ffd1e6)";
  // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '69' ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏°‡πà‡∏ß‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏µ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™3-4 ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡πà‡∏ß‡∏á)
  if (/69/.test(sheetName)) {
    mainColor = "#e1bee7"; darkColor = "#6a1b9a";
    bg = "linear-gradient(to bottom right, #f3e5f5, #e1bee7)";
  }
  document.body.style.background = bg;
  header.style.color = darkColor;
  date.style.color = darkColor;
  downloadBtn.style.backgroundColor = mainColor;
  downloadBtn.style.color = darkColor;
  ths.forEach(th => { th.style.backgroundColor = mainColor; th.style.color = darkColor; });
}

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ filter
document.getElementById('filterInput').addEventListener('keyup', function() {
  const keyword = this.value.toLowerCase();
  const rows = document.querySelectorAll('#tableBody tr');
  rows.forEach(r => {
    const text = r.innerText.toLowerCase();
    r.style.display = text.includes(keyword) ? '' : 'none';
  });
});

// ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel (SheetJS) ‚Äî ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏°‡∏õ header styling (‡∏™‡∏µ,‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤) ‡∏ï‡∏≤‡∏° theme ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
async function downloadExcel() {
  const table = document.getElementById('dataTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);

  // ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏ï‡∏≤‡∏° sheetName (‡πÅ‡∏ó‡∏ô‡∏™‡∏µ header)
  let colorHeader = /69/.test(currentSheet) ? "E1BEE7" : "F8BBD0";
  let colorText = /69/.test(currentSheet) ? "6A1B9A" : "880E4F";

  // Add simple style for first few header rows (SheetJS styling)
  if (ws['!ref']) {
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 0; R <= END_HEADER_ROW; ++R) {
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
        if (!ws[cellRef]) continue;
        ws[cellRef].s = {
          fill: { fgColor: { rgb: colorHeader } },
          font: { bold: true, color: { rgb: colorText } },
          alignment: { horizontal: "center", vertical: "center" },
          border: {
            top: { style: "thin", color: { rgb: "B36A84" } },
            left: { style: "thin", color: { rgb: "B36A84" } },
            right: { style: "thin", color: { rgb: "B36A84" } },
            bottom: { style: "thin", color: { rgb: "B36A84" } }
          }
        };
      }
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, currentSheet || 'Report');
  const fileName = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô_${currentSheet || 'report'}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
window.onload = () => {
  loadSheetList();
};
</script>
</body>
</html>
