<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>โปรแกรมคำนวณและจัดการหนี้</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      background: 
        linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), url('https://i.postimg.cc/507bjy9Z/cdd.png') center/cover no-repeat fixed;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
    }

    .container {
      border-radius: 25px;
      padding: 40px 30px;
      box-shadow: 0 8px 25px rgba(233, 30, 99, 0.3);
      width: 100%;
      max-width: 600px;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.92);
    }

    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-text h1 {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
      color: navy;
    }

    .header-text h2 {
      font-size: 1.2rem;
      margin: 5px 0;
      color: deeppink;
    }

    .logos img {
      height: 60px;
      margin-left: 5px;
    }

    .table-container {
      border-radius: 25px;
      padding: 30px;
      box-shadow: 0 8px 25px rgba(0, 81, 150, 0.3);
      width: 100%;
      max-width: 1200px;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.95);
    }

    .table-container h1 {
        color: navy;
        text-align: center;
        margin-bottom: 10px;
    }
    
    .upload-section {
        background-color: #e3f2fd;
        border: 2px dashed #0d47a1;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    .upload-section label {
        font-weight: bold;
        color: #0d47a1;
        font-size: 1.1rem;
        margin-bottom: 10px;
        display: block;
    }
    input[type="file"] {
        border: 1px solid #90caf9;
        padding: 8px;
        border-radius: 8px;
        width: 100%;
        max-width: 350px;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        white-space: nowrap;
    }
    
    td:nth-child(3), td:nth-child(4), td:nth-child(5), td:nth-child(6), td:nth-child(7),
    td:nth-child(8), td:nth-child(10), td:nth-child(11), td:nth-child(12), td:nth-child(13),
    td:nth-child(14), td:nth-child(15), td:nth-child(16), td:nth-child(17) {
        text-align: right; /* จัดตัวเลขชิดขวา */
    }

    thead th {
        background-color: #002D62;
        color: white;
        position: sticky;
        top: 0;
    }

    tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    
    .status-paid { background-color: #d4edda !important; color: #155724; }
    .status-due { background-color: #f8d7da !important; color: #721c24; }
    .status-future { background-color: white !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-section">
      <div class="header-text">
        <h1>Dashboard จัดการหนี้</h1>
        <h2>กองทุนพัฒนาบทบาทสตรี</h2>
      </div>
      <div class="logos">
        <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD Logo" />
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Women Fund Logo" />
      </div>
    </div>
  </div>

  <div class="table-container">
    <h1>ตารางคำนวณและตัดชำระหนี้</h1>
    
    <div class="upload-section">
        <label for="excel-file">เลือกไฟล์ Excel (.xlsx, .xls, .csv) เพื่อแสดงข้อมูล</label>
        <input type="file" id="excel-file" accept=".xlsx, .xls, .csv">
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ลำดับ</th>
                    <th>กำหนดวันชำระ</th>
                    <th>เงินต้น</th>
                    <th>ดอกเบี้ย</th>
                    <th>เบี้ยปรับ</th>
                    <th>ด/บ ผิดนัดเดิม</th>
                    <th>ด/บ ผิดนัดใหม่</th>
                    <th>รวม</th>
                    <th>วันที่ชำระ</th>
                    <th>เงินที่ชำระ</th>
                    <th>รับคืน ด/บ ผิดนัดเดิม</th>
                    <th>รับคืน ด/บ ผิดนัดใหม่</th>
                    <th>รับคืนเบี้ยปรับ</th>
                    <th>รับคืนดอกเบี้ย</th>
                    <th>รับคืนเงินต้น</th>
                    <th>รับคืนรวม</th>
                    <th>หนี้คงเหลือ</th>
                    <th>สถานะ</th>
                </tr>
            </thead>
            <tbody id="payment-table-body">
                <tr>
                    <td colspan="18" style="text-align:center; padding: 40px; color: #555;">กรุณาเลือกไฟล์ Excel เพื่อแสดงข้อมูล...</td>
                </tr>
            </tbody>
        </table>
    </div>
  </div>

  <script>
    function applyRowColors() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const rows = document.querySelectorAll("#payment-table-body tr");
        if (rows.length === 0) return;

        rows.forEach(row => {
            const dueDateCell = row.cells[1];
            const statusCell = row.cells[17];
            
            if (!dueDateCell || !statusCell || !dueDateCell.textContent) return;

            let dateParts = dueDateCell.textContent.split('/');
            const dueDate = dateParts.length === 3 ? new Date(dateParts[2] - 543, dateParts[1] - 1, dateParts[0]) : new Date(dueDateCell.textContent);

            const status = statusCell.textContent.trim();

            row.classList.remove('status-paid', 'status-due', 'status-future');
            
            if (status === "ชำระครบแล้ว") {
                row.classList.add('status-paid');
            } else if (status === "ค้างชำระ" && dueDate < today) {
                row.classList.add('status-due');
            } else {
                 row.classList.add('status-future');
            }
        });
    }

    const excelFileInput = document.getElementById('excel-file');

    excelFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
            
            const tableBody = document.getElementById('payment-table-body');
            tableBody.innerHTML = '';

            jsonData.forEach(rowData => {
                const tr = document.createElement('tr');
                
                // *** START: ส่วนที่แก้ไขตามคำขอ ***
                // 1. ดึงค่าตัวเลขสำหรับคำนวณออกมาและแปลงเป็นตัวเลข (ป้องกัน error ถ้าเซลล์ว่าง)
                const principal = parseFloat(rowData['เงินต้น'] || 0);
                const interest = parseFloat(rowData['ดอกเบี้ย'] || 0);
                const penalty = parseFloat(rowData['เบี้ยปรับ'] || 0);
                const oldDefaultInterest = parseFloat(rowData['ด/บ ผิดนัดเดิม'] || 0);
                const newDefaultInterest = parseFloat(rowData['ด/บ ผิดนัดใหม่'] || 0);

                // 2. คำนวณยอด 'รวม' โดยใช้สูตร SUM จากค่าด้านบน
                const calculatedTotal = principal + interest + penalty + oldDefaultInterest + newDefaultInterest;
                // *** END: ส่วนที่แก้ไขตามคำขอ ***
                
                const cells = [
                    rowData['ลำดับ'] || '',
                    rowData['กำหนดวันชำระ'] ? new Date(rowData['กำหนดวันชำระ']).toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '',
                    principal,
                    interest,
                    penalty,
                    oldDefaultInterest,
                    newDefaultInterest,
                    calculatedTotal, // << ใช้ค่าที่คำนวณใหม่ตรงนี้
                    rowData['วันที่ชำระ'] ? new Date(rowData['วันที่ชำระ']).toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '-',
                    parseFloat(rowData['เงินที่ชำระ'] || 0),
                    parseFloat(rowData['รับคืน ด/บ ผิดนัดเดิม'] || 0),
                    parseFloat(rowData['รับคืน ด/บ ผิดนัดใหม่'] || 0),
                    parseFloat(rowData['รับคืนเบี้ยปรับ'] || 0),
                    parseFloat(rowData['รับคืนดอกเบี้ย'] || 0),
                    parseFloat(rowData['รับคืนเงินต้น'] || 0),
                    parseFloat(rowData['รับคืนรวม'] || 0),
                    parseFloat(rowData['หนี้คงเหลือ'] || 0), // หากคอลัมน์นี้มีสูตรใน Excel ก็สามารถคำนวณแบบเดียวกับ 'รวม' ได้เช่นกัน
                    rowData['สถานะ'] || ''
                ];
                
                cells.forEach(cellData => {
                    const td = document.createElement('td');
                    if (typeof cellData === 'number') {
                        td.textContent = cellData.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    } else {
                        td.textContent = cellData;
                    }
                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
            
            applyRowColors();
        };

        reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
