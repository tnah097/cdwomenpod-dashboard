<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>รายงานผลกองทุนพัฒนาบทบาทสตรี</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: 'Sarabun', sans-serif;
  margin: 0;
}
.custom-scrollbar::-webkit-scrollbar { width: 12px; height: 12px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #fdfdfd; border-radius: 6px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #f8bbd0; border-radius: 6px; border: 3px solid #fdfdfd; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #880e4f; }

@media print {
  .no-print { display: none !important; }
}
</style>
</head>

<body>
<div id="app"></div>

<script>
/* ================= CONFIG ================= */
const API_URL = 'https://script.google.com/macros/s/AKfycbxIDBqQkRdzRZsFsqTrxcdCg0FXY-NoxZ8UaFFKNG9oOGWr3G67vYmjw4vEpXoKLbH1_Q/exec';

const THEMES = {
  "ไตรมาส 1-2": {
    main: '#f8bbd0',
    dark: '#880e4f',
    gradient: 'linear-gradient(to bottom right, #ffe6f0, #ffd1e6)',
    border: '#f48fb1'
  },
  "ไตรมาส 3-4": {
    main: '#e1bee7',
    dark: '#6a1b9a',
    gradient: 'linear-gradient(to bottom right, #f3e5f5, #e1bee7)',
    border: '#ce93d8'
  }
};

const LOGO_CDD = 'https://i.postimg.cc/507bjy9Z/cdd.png';
const LOGO_WOMEN = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s';

const START_HEADER_ROW = 3;
const END_HEADER_ROW = 4;
const START_BODY_ROW = 5;

/* ================= STATE ================= */
let currentQuarter = 'ไตรมาส 1-2';
let rawData = [];
let mergedData = [];
let searchQuery = '';

/* ================= INIT ================= */
loadData();

/* ================= FUNCTIONS ================= */

async function loadData() {
  const res = await fetch(`${API_URL}?sheetName=${encodeURIComponent(currentQuarter)}`);
  const json = await res.json();
  rawData = json.data;
  mergedData = json.merged || [];
  render();
}

function exportExcel() {
  const ws = XLSX.utils.aoa_to_sheet(rawData.slice(START_HEADER_ROW));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'รายงาน');
  XLSX.writeFile(wb, `รายงาน_${currentQuarter}.xlsx`);
}

function render() {
  const theme = THEMES[currentQuarter];
  document.body.style.background = theme.gradient;

  const headerText = rawData.slice(0,2).map(r=>r.join(' ')).join('<br>');
  const dateText = rawData[2]?.join(' ') || '';

  const bodyRows = rawData.slice(START_BODY_ROW).filter(r=>{
    if(!searchQuery) return true;
    return r.join(' ').toLowerCase().includes(searchQuery.toLowerCase());
  });

  document.getElementById('app').innerHTML = `
  <div class="min-h-screen p-6 flex justify-center">
    <div class="w-full max-w-[1700px] bg-white rounded-[30px] p-8 shadow-2xl relative">

      <div class="absolute top-6 right-6 flex gap-3 no-print">
        <img src="${LOGO_CDD}" class="h-14"/>
        <img src="${LOGO_WOMEN}" class="h-14"/>
      </div>

      <div class="mt-10 mb-6 text-center">
        <h1 class="text-2xl font-bold" style="color:${theme.dark}">${headerText}</h1>
        <p class="text-right font-bold mt-4" style="color:${theme.dark}">${dateText}</p>
      </div>

      <div class="flex gap-4 items-center mb-6 no-print">
        <select onchange="changeQuarter(this.value)" class="border px-3 py-2 rounded">
          <option ${currentQuarter==='ไตรมาส 1-2'?'selected':''}>ไตรมาส 1-2</option>
          <option ${currentQuarter==='ไตรมาส 3-4'?'selected':''}>ไตรมาส 3-4</option>
        </select>

        <input placeholder="ค้นหา..." oninput="searchQuery=this.value;render()" class="border px-3 py-2 rounded flex-1"/>

        <button onclick="exportExcel()" class="px-4 py-2 rounded font-bold" style="background:${theme.main};color:${theme.dark}">
          Export Excel
        </button>

        <button onclick="window.print()" class="px-4 py-2 rounded font-bold border">
          Print PDF
        </button>
      </div>

      <div class="overflow-auto custom-scrollbar max-h-[60vh] border rounded">
        <table class="w-full border-collapse text-sm">
          <thead>
            ${renderHeader()}
          </thead>
          <tbody>
            ${bodyRows.map(r=>`<tr>${r.map(c=>`<td class="border px-2 py-1">${c||''}</td>`).join('')}</tr>`).join('')}
          </tbody>
        </table>
      </div>

    </div>
  </div>
  `;
}

function renderHeader() {
  return rawData.slice(START_HEADER_ROW, END_HEADER_ROW+1)
    .map(r=>`<tr>${r.map(c=>`<th class="border px-2 py-1 bg-pink-200">${c||''}</th>`).join('')}</tr>`)
    .join('');
}

function changeQuarter(q) {
  currentQuarter = q;
  loadData();
}
</script>
</body>
</html>
