<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>CDWomenPOD Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 0; }
  header { background-color: #004080; color: white; padding: 10px 20px; }
  h1 { margin: 0; font-size: 24px; }
  .container { padding: 20px; }
  select, button { padding: 5px; margin-right: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  th { background-color: #e0e0e0; }
  .merge-row td { font-weight: bold; background-color: #f0f0f0; }
  .chart-container { width: 100%; display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
  .chart { flex: 1 1 45%; background: white; padding: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>CDWomenPOD Dashboard</h1>
</header>
<div class="container">
  <div>
    <label>จังหวัด: </label>
    <select id="provinceSelect"></select>
    <label>อำเภอ: </label>
    <select id="districtSelect"></select>
    <label>ตำบล: </label>
    <select id="subdistrictSelect"></select>
    <button onclick="exportExcel()">Export Excel</button>
  </div>
  <table id="dataTable">
    <thead>
      <tr>
        <th>ลำดับ</th>
        <th>จังหวัด</th>
        <th>อำเภอ/เขต</th>
        <th>ตำบล</th>
        <th>ปีงบประมาณ</th>
        <th>เลขที่สัญญา</th>
        <th>ชื่อโครงการ</th>
        <th>ผู้เสนอโครงการ</th>
        <th>เงินอนุมัติ</th>
        <th>ลูกหนี้คงเหลือต้นปีบัญชี</th>
        <th>ลูกหนี้คงเหลือ ณ ปัจจุบัน</th>
        <th>หนี้ยังไม่ถึงกำหนดชำระ</th>
        <th>การไกล่เกลี่ยที่สามารถใช้บังคับคดีได้</th>
        <th>ลูกหนี้ที่ได้ดำเนินการตามกฎหมาย</th>
        <th>จำนวนหนี้ที่เกินกำหนดชำระ</th>
        <th>ร้อยละหนี้เกินกำหนดชำระ</th>
        <th>สถานะโครงการ</th>
        <th>หมายเหตุ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="chart-container">
    <div class="chart"><canvas id="barChart"></canvas></div>
    <div class="chart"><canvas id="pieChart"></canvas></div>
  </div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbwrhmVSkula-MvjAqt1Nq2Dk79x6Y_GA1JrLFVyAl-R0kyZpUMripxSpKmgsflNGgOV-Q/exec";
let allData = [];
let provinceMap = {};

async function fetchProvinces() {
  const res = await fetch(apiUrl + "?action=listProvinces");
  const data = await res.json();
  const provinceSelect = document.getElementById("provinceSelect");
  data.forEach(p => {
    provinceMap[p.name] = p.fileId;
    const option = document.createElement("option");
    option.value = p.name;
    option.textContent = p.name;
    provinceSelect.appendChild(option);
  });
  provinceSelect.addEventListener("change", loadProvinceData);
  if(data.length>0) loadProvinceData();
}

async function loadProvinceData() {
  const province = document.getElementById("provinceSelect").value;
  const fileId = provinceMap[province];
  if(!fileId) return;

  const res = await fetch(apiUrl + `?action=getData&fileId=${fileId}`);
  const data = await res.json();
  allData = data;
  populateTable();
  populateDropdowns();
  renderCharts();
}

function populateTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  allData.forEach((row, index) => {
    const tr = document.createElement("tr");
    if(row.merge) tr.classList.add("merge-row");
    const cells = [
      row.merge ? "" : index+1,
      row.province,
      row.district,
      row.subdistrict,
      row.year,
      row.contractNo,
      row.projectName,
      row.proposer,
      row.approved,
      row.debtStart,
      row.debtCurrent,
      row.debtNotDue,
      row.debtMediation,
      row.debtLegal,
      row.debtOver,
      row.debtOverPercent,
      row.status,
      row.note
    ];
    cells.forEach(c => {
      const td = document.createElement("td");
      td.textContent = c;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function populateDropdowns() {
  const districtSelect = document.getElementById("districtSelect");
  const subdistrictSelect = document.getElementById("subdistrictSelect");
  const districts = [...new Set(allData.map(d=>d.district))].sort();
  const subdistricts = [...new Set(allData.map(d=>d.subdistrict))].sort();
  districtSelect.innerHTML = '<option value="">ทั้งหมด</option>';
  subdistrictSelect.innerHTML = '<option value="">ทั้งหมด</option>';
  districts.forEach(d=>districtSelect.appendChild(new Option(d,d)));
  subdistricts.forEach(d=>subdistrictSelect.appendChild(new Option(d,d)));
}

function renderCharts() {
  const barCtx = document.getElementById("barChart").getContext("2d");
  const pieCtx = document.getElementById("pieChart").getContext("2d");
  const barData = {
    labels: allData.map(d=>d.projectName),
    datasets: [
      { label:"ลูกหนี้คงเหลือต้นปีบัญชี", data: allData.map(d=>d.debtStart), backgroundColor:"rgba(75,192,192,0.6)" },
      { label:"ลูกหนี้คงเหลือ ณ ปัจจุบัน", data: allData.map(d=>d.debtCurrent), backgroundColor:"rgba(153,102,255,0.6)" }
    ]
  };
  const pieData = {
    labels:["ลูกหนี้คงเหลือ ณ ปัจจุบัน","หนี้ยังไม่ถึงกำหนดชำระ","การไกล่เกลี่ยที่สามารถใช้บังคับคดีได้","ลูกหนี้ที่ได้ดำเนินการตามกฎหมาย","จำนวนหนี้ที่เกินกำหนดชำระ","ร้อยละหนี้เกินกำหนดชำระ"],
    datasets:[{
      data: [
        sumField("debtCurrent"),
        sumField("debtNotDue"),
        sumField("debtMediation"),
        sumField("debtLegal"),
        sumField("debtOver"),
        sumField("debtOverPercent")
      ],
      backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40"]
    }]
  };
  if(window.barChart) window.barChart.destroy();
  if(window.pieChart) window.pieChart.destroy();
  window.barChart = new Chart(barCtx,{type:"bar",data:barData,options:{responsive:true,scales:{y:{beginAtZero:true}}}});
  window.pieChart = new Chart(pieCtx,{type:"pie",data:pieData,options:{responsive:true}});
}

function sumField(field) {
  return allData.reduce((acc,d)=>acc+(parseFloat(d[field])||0),0);
}

function exportExcel() {
  const csvRows = [];
  const headers = ["ลำดับ","จังหวัด","อำเภอ/เขต","ตำบล","ปีงบประมาณ","เลขที่สัญญา","ชื่อโครงการ","ผู้เสนอโครงการ","เงินอนุมัติ","ลูกหนี้คงเหลือต้นปีบัญชี","ลูกหนี้คงเหลือ ณ ปัจจุบัน","หนี้ยังไม่ถึงกำหนดชำระ","การไกล่เกลี่ยที่สามารถใช้บังคับคดีได้","ลูกหนี้ที่ได้ดำเนินการตามกฎหมาย","จำนวนหนี้ที่เกินกำหนดชำระ","ร้อยละหนี้เกินกำหนดชำระ","สถานะโครงการ","หมายเหตุ"];
  csvRows.push(headers.join(","));
  allData.forEach((row,index)=>{
    const cells = [
      row.merge ? "" : index+1,
      row.province,row.district,row.subdistrict,row.year,row.contractNo,row.projectName,row.proposer,row.approved,row.debtStart,row.debtCurrent,row.debtNotDue,row.debtMediation,row.debtLegal,row.debtOver,row.debtOverPercent,row.status,row.note
    ];
    csvRows.push(cells.map(c=>`"${c}"`).join(","));
  });
  const blob = new Blob([csvRows.join("\n")],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "dashboard_export.csv";
  a.click();
  URL.revokeObjectURL(url);
}

fetchProvinces();
</script>
</body>
</html>
