<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CDDWomenfund Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    /* --- Visual --- */
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0;
      background: linear-gradient(to bottom right, #ffe6f0, #f3e5f5, #e1bee7);
      background-attachment: fixed;
      color: #000;
    }
    .dashboard-container { padding: 24px; background: rgba(255,255,255,0.95); min-height:100vh; box-sizing:border-box; }

    .header { display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:12px; }
    .header-text h1{ margin:0; font-size:2.2rem; } .header-text h2{ margin:0; font-size:1.05rem; }
    .logo-container img{ height:60px; margin-left:10px; }

    .cards { display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; }
    .card{ padding:12px; border-radius:10px; color:#fff; min-width:220px; font-weight:700; }
    .card .value{ color:#000; font-weight:500; margin-top:6px; font-size:1.15rem; white-space:nowrap; }
    .card.pink{ background:#e91e63; } .card.light-pink{ background:#f8bbd0; } .card.orange{ background:#ff9800; }
    .card.pastel-pink{ background:#FFAFB0; } .card.deep-pastel-pink{ background:#f06292; }

    /* main visuals + study center aligned in one row */
    .main-visuals { display:flex; gap:16px; margin-top:18px; align-items:flex-start; flex-wrap:wrap; }
    .left{ flex:1 1 420px; min-width:300px; }
    .center{ flex:0 0 420px; text-align:center; }
    .right{ flex:0 0 360px; min-width:280px; }

    canvas{ max-width:100%; }
    .section-title{ text-align:center; font-weight:700; margin-bottom:8px; }

    /* study center box */
    .study-center-box{ background:#f06292; color:#fff; border-radius:10px; padding:12px; }
    .study-center-box .title{ font-weight:800; }
    .study-center-box table{ width:100%; background:#fff; color:#000; border-collapse:collapse; margin-top:8px; border-radius:6px; overflow:hidden; }
    .study-center-box th, .study-center-box td{ padding:8px 6px; border-bottom:1px solid #eee; text-align:left; font-weight:600; }
    .study-center-box tbody tr:hover{ background:#f2f6fb; cursor:pointer; }
    .study-center-box tbody tr.selected-row{ background:#d1e7fd !important; font-weight:700; }

    /* province table wrapper: single vertical scrollbar only */
    .province-table-wrapper { margin-top:18px; max-height:460px; overflow:auto; border-radius:8px; box-shadow: 0 0 0 1px rgba(240,240,240,1) inset; }
    .summary-table { border-collapse: separate; width: max-content; min-width:100%; table-layout:auto; white-space:nowrap; }
    .summary-table thead th {
      position: sticky; top:0; z-index:30;
      background:#f06292; color:#000; padding:10px 12px; border:1px solid #f8bbd0; text-align:center; font-weight:700;
    }
    .summary-table tbody td{ padding:8px 12px; border:1px solid #f8bbd0; text-align:center; vertical-align:middle; white-space:nowrap; }
    .summary-table tr:nth-child(even){ background:#fce4ec; } .summary-table tr:nth-child(odd){ background:#fff; }

    .province-link{ color:blue; text-decoration:underline; }
    .align-left{ text-align:left !important; } .align-right{ text-align:right !important; } .align-center{ text-align:center !important; }

    /* avoid double scrollbars: study center has its own small max-height and overflow auto,
       province table has the main vertical scroll in .province-table-wrapper only */
    #studyCenterTable { width:100%; }
    #studyCenterTable tbody{ max-height:260px; }

    /* responsive */
    @media (max-width:1000px){
      .main-visuals { flex-direction:column; align-items:center; }
      .center{ order:2; }
      .right{ order:3; width:100%; }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="header">
      <div class="header-text">
        <h1><span style="color:navy">CDD</span><span style="color:deeppink">Women</span><span style="color:red">Fund</span></h1>
        <h2><span style="color:#000">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </span><span style="color:deeppink">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</span> <span style="color:red" id="province-title">‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span></h2>
        <div style="color:navy; font-weight:700; margin-top:8px;">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏ï‡∏£‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</div>
      </div>
      <div class="logo-container">
        <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD" />
      </div>
    </div>

    <div style="text-align:right; font-weight:700; color:navy; margin-top:8px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568</div>
    <div id="log">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...</div>

    <!-- cards -->
    <div class="cards">
      <div class="card pink">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£<div class="value" id="num-projects">-</div>
        ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<div class="value" id="approved-money-card1">-</div>
        ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568<div class="value" id="debt-start-card1">-</div>
      </div>
      <div class="card light-pink">
        ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)<div class="value" id="debt-now-card2">-</div>
        ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô<div class="value" id="recovered-principal">-</div>
        ‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)<div class="value" id="not-due-card2">-</div>
      </div>
      <div class="card orange">
        ‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)<div class="value" id="mediation">-</div>
        ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏á1)<div class="value" id="prosecutor">-</div>
        ‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á (‡∏á2)<div class="value" id="court-filed">-</div>
        ‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤ (‡∏á3)<div class="value" id="court-judgement">-</div>
      </div>
      <div class="card pastel-pink">
        ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)<div class="value" id="legal-card4">-</div>
        ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ<div class="value" id="principal-legal">-</div>
      </div>
      <div class="card deep-pastel-pink">
        ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)<div class="value" id="overdue-card5">-</div>
        ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞<div class="value" id="percent-overdue-card5">-</div>
      </div>
    </div>

    <!-- main visuals + study center -->
    <div class="main-visuals">
      <div class="left">
        <div class="section-title">10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
        <canvas id="donutChart"></canvas>
      </div>

      <div class="center">
        <img src="https://i.postimg.cc/pTR4HCg3/women5-copy.png" alt="‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á" style="width:300px; height:auto;" />
      </div>

      <div class="right">
        <div class="study-center-box">
          <div class="title">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</div>
          <table id="studyCenterTable" class="summary-table" aria-label="Study centers">
            <thead>
              <tr>
                <th class="clickable-header" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                <th style="text-align:center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- province table (single scroll container) -->
    <div class="province-table-wrapper" id="provinceTableWrapper">
      <table class="summary-table" id="provinceTable" role="grid" aria-describedby="log">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
/* ========== Config ========== */
const API_URL = "https://script.google.com/macros/s/AKfycbzMxEWPAJZ_6T8kUxQPGdsvbuFya-M9rpq_bIybdsQztHbfO49roTju3ABGUrp3nJcQWQ/exec";
let donutChartInstance = null;
let provinceDataTable = null;

/* column mapping and order (kept same as your model) */
const columnMap = {
  province: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
  totalProjects: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
  approvedAmount: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
  debtStart: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568",
  debtNow: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)",
  notDue: "‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)",
  recoveredPrincipal: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô",
  recoveredInterest: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢",
  recoveredFine: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏±‡∏ö",
  recoveredPenaltyInterest: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î",
  recoveredOverpay: "‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô",
  recoveredTotal: "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ß‡∏°",
  debtAsOf30968: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 30 ‡∏Å.‡∏¢. 2568",
  mediation: "‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)",
  prosecutor: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏á1)",
  courtFiled: "‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á (‡∏á2)",
  courtJudgement: "‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤ (‡∏á3)",
  courtConsent: "‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏° (‡∏á4)",
  civilLaw20: "‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°.20 ‡∏ï‡∏£‡∏µ (‡∏á5)",
  criminalAction: "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤ (‡∏á6)",
  legalAction: "‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)",
  principalLegal: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ",
  overdueLegal: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£",
  overdue: "‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)",
  overduePercent: "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (C)",
  contractEndDebt: "‡∏à‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á (D)",
  over5Percent: "‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 5 (E)",
  statusPayment: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ",
  projectStatus: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
  notes: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
};
const orderedColumns = ["province","totalProjects","approvedAmount","debtStart","debtNow","notDue","recoveredPrincipal","recoveredInterest","recoveredFine","recoveredPenaltyInterest","recoveredOverpay","recoveredTotal","debtAsOf30968","mediation","prosecutor","courtFiled","courtJudgement","courtConsent","civilLaw20","criminalAction","legalAction","principalLegal","overdueLegal","overdue","overduePercent","contractEndDebt","over5Percent","statusPayment","projectStatus","notes"];

function formatNumber(num){
  if (num===null||num===undefined||String(num).trim()==="") return "-";
  const n = Number(String(num).replace(/[^0-9.-]/g,''));
  if (!isFinite(n)) return String(num);
  return n.toLocaleString("th-TH");
}
function formatPercent(val){
  const num=parseFloat(String(val).replace(/[^0-9.-]/g,''));
  return isNaN(num)?"-":num.toFixed(2)+"%";
}

/* ========== Fetch + Render ========== */
async function fetchData(){
  const logEl=document.getElementById("log");
  try{
    logEl.textContent = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...";
    const res = await fetch(API_URL);
    const data = await res.json();
    if (data.error) { console.error("Apps Script Error:", data.error); logEl.textContent="‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; return; }

    const overview = data.overview || {};
    const pieChartData = data.topOverdue || [];
    const provinces = Array.isArray(data.provinces) ? data.provinces.slice() : [];

    // --- Update cards (keep same IDs) ---
    document.getElementById('num-projects').textContent = formatNumber(overview.B2);
    document.getElementById('approved-money-card1').textContent = formatNumber(overview.C2);
    document.getElementById('debt-start-card1').textContent = formatNumber(overview.D2);
    document.getElementById('debt-now-card2').textContent = formatNumber(overview.E2);
    document.getElementById('recovered-principal').textContent = formatNumber(overview.G2);
    document.getElementById('not-due-card2').textContent = formatNumber(overview.F2);
    document.getElementById('mediation').textContent = formatNumber(overview.H2);
    document.getElementById('prosecutor').textContent = formatNumber(overview.I2);
    document.getElementById('court-filed').textContent = formatNumber(overview.J2);
    document.getElementById('court-judgement').textContent = formatNumber(overview.K2);
    document.getElementById('legal-card4').textContent = formatNumber(overview.O2);
    document.getElementById('principal-legal').textContent = formatNumber(overview.P2);
    document.getElementById('overdue-card5').textContent = formatNumber(overview.R2);
    document.getElementById('percent-overdue-card5').textContent = formatPercent(overview.S2);

    // --- Donut ---
    if (donutChartInstance) donutChartInstance.destroy();
    const ctx = document.getElementById('donutChart').getContext('2d');
    donutChartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: pieChartData.map(p=>p.province),
        datasets: [{ data: pieChartData.map(p=>parseFloat(p.percent)||0) }]
      },
      options: { responsive:true, plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label(c){ return `${c.label}: ${parseFloat(c.raw).toFixed(2)}%`; }}}}}
    });

    // --- Province table render ---
    const table = document.querySelector("#provinceTable");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML="";

    if (!provinces || provinces.length===0){
      thead.innerHTML = "<tr><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th></tr>";
      logEl.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î";
      return;
    }

    // determine final columns (use orderedColumns first)
    const responseKeys = Object.keys(provinces[0]);
    const orderedPresent = orderedColumns.filter(k=>responseKeys.includes(k));
    const remaining = responseKeys.filter(k=>!orderedPresent.includes(k));
    const finalColumns = [...orderedPresent, ...remaining];

    // header
    thead.innerHTML = `<tr>${finalColumns.map(k=>`<th>${columnMap[k]||k}</th>`).join('')}</tr>`;

    // rows
    provinces.forEach(p=>{
      const url = `province2569.html?province=${encodeURIComponent(p.province||"")}`;
      const rowHTML = finalColumns.map(k=>{
        const raw = p[k];
        if (k==="province"){
          const display = (raw===null||raw===undefined||raw==="") ? "-" : raw;
          return `<td class="align-left"><a class="province-link" href="${url}" target="_blank" rel="noopener">${display}</a></td>`;
        }
        if (String(k).toLowerCase().includes("percent")){
          return `<td class="align-center">${formatPercent(raw)}</td>`;
        }
        if (raw===null||raw===undefined||raw==="") return `<td class="align-center">-</td>`;
        const numericCandidate = Number(String(raw).replace(/[^0-9.-]/g,''));
        if (isFinite(numericCandidate)) return `<td class="align-right">${formatNumber(numericCandidate)}</td>`;
        return `<td class="align-left">${String(raw)}</td>`;
      }).join("");
      tbody.innerHTML += `<tr>${rowHTML}</tr>`;
    });

    // initialize DataTable WITHOUT vertical scroll (we use wrapper's overflow:auto to have single scrollbar)
    if ($.fn.DataTable.isDataTable('#provinceTable')) $('#provinceTable').DataTable().clear().destroy();
    provinceDataTable = $('#provinceTable').DataTable({
      paging:false,
      ordering: false,
      info:false,
      autoWidth:false,
      scrollX: true, // allow horizontal scrolling if needed
      language: { search:"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", zeroRecords:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" },
      // DO NOT enable scrollY or fixedHeader to avoid duplicate header/scrollbar -- we use CSS sticky header
      initComplete: function(){ try{ this.api().columns.adjust(); }catch(e){} }
    });

    // ensure wrapper scroll and DataTable columns align
    setTimeout(()=>{ try{ provinceDataTable.columns.adjust().draw(false); }catch(e){} }, 120);

    logEl.textContent = "‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }catch(err){
    console.error(err);
    document.getElementById("log").textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  }
}

/* ========== Study center fetch + render + interactions ========== */
async function fetchStudyCenterData(){
  try{
    const res = await fetch(`${API_URL}?action=studyCenter`);
    const data = await res.json();
    if (data.error){ console.error("Apps Script Error:", data.error); return; }
    const centers = data.studyCenter || [];

    const tbody = document.querySelector("#studyCenterTable tbody");
    tbody.innerHTML = "";

    centers.forEach(row=>{
      // row.province expected as comma-separated province names
      const provincesKey = (row.province||"").split(',').map(s=>s.trim()).filter(Boolean).join('|');
      const tr = document.createElement('tr');
      tr.setAttribute('data-provinces', provincesKey);
      tr.innerHTML = `<td class="align-left">${row.name||''}</td><td class="align-center">${Number(row.index||0).toLocaleString("th-TH")}</td><td class="align-left">${row.province||''}</td>`;
      tbody.appendChild(tr);
    });

    // init DataTable for studyCenter (no vertical scroll that would create nested scrollbar)
    if ($.fn.DataTable.isDataTable('#studyCenterTable')) $('#studyCenterTable').DataTable().clear().destroy();
    const studyTable = $('#studyCenterTable').DataTable({
      paging:false, searching:true, info:false, ordering:false, autoWidth:false,
      language:{search:"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", zeroRecords:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"},
      initComplete:function(){ try{ this.api().columns.adjust(); }catch(e){} }
    });
    setTimeout(()=>{ studyTable.columns.adjust().draw(false); }, 150);

    // click handler: filter province table by first column (province name)
    const body = $('#studyCenterTable tbody');
    body.off('click').on('click','tr', function(){
      if (!provinceDataTable) return;
      const isSelected = $(this).hasClass('selected-row');
      body.find('tr').removeClass('selected-row');
      if (!isSelected){
        $(this).addClass('selected-row');
        const provinces = $(this).data('provinces'); // e.g. "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø|‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£"
        // build regex matching exactly province names in column 0
        const regex = `^(${provinces})$`;
        provinceDataTable.column(0).search(regex, true, false).draw();
      }else{
        provinceDataTable.column(0).search('').draw();
      }
    });

    // clickable header resets filter
    $('.clickable-header').off('click').on('click', ()=> {
      if (!provinceDataTable) return;
      body.find('tr').removeClass('selected-row');
      provinceDataTable.column(0).search('').draw();
    });

  }catch(err){ console.error(err); }
}

/* ========== Init ========== */
fetchData();
fetchStudyCenterData();
</script>
</body>
</html>