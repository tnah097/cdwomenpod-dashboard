<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>โครงการที่ติดลบ</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Sarabun', sans-serif;
  margin: 0;
  overflow: hidden;
}

/* scrollbar */
.custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,.25); border-radius: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f5f5f5; }

/* sticky shadow */
.sticky-shadow {
  box-shadow: inset -2px 0 0 rgba(0,0,0,.15);
}
</style>

<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client"
  }
}
</script>
</head>

<body class="bg-gray-50">
<div id="root"></div>

<script type="text/babel" data-type="module">
import React, { useEffect, useState, useMemo } from "react";
import ReactDOM from "react-dom/client";

const API_URL = "https://script.google.com/macros/s/AKfycbyk-He5CinBT7rz6_JzZictTZEw-7qclJjDLBldIuzwDOnDkQiksmH2iiHnZeEhT8z6hA/exec";

const START_HEADER_ROW = 3;
const END_HEADER_ROW = 4;
const START_BODY_ROW = 5;

function measureWidth(text) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  ctx.font = "bold 14px Sarabun";
  return Math.min(Math.max(ctx.measureText(text).width + 40, 90), 420);
}

function App() {
  const [data, setData] = useState([]);
  const [merged, setMerged] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch(API_URL)
      .then(r => r.json())
      .then(res => {
        setData(res);
        setMerged([]);
        setLoading(false);
      });
  }, []);

  const headers = useMemo(
    () => data.slice(START_HEADER_ROW, END_HEADER_ROW + 1),
    [data]
  );

  const body = useMemo(
    () => data.slice(START_BODY_ROW),
    [data]
  );

  const colWidths = useMemo(() => {
    if (!headers.length) return [];
    return headers[headers.length - 1].map(h => measureWidth(h || ""));
  }, [headers]);

  return (
    <div className="min-h-screen p-6 flex justify-center">
      <div className="w-full max-w-[1700px] bg-white rounded-[30px] p-6 shadow-2xl flex flex-col">

        <div className="text-center mb-4 font-bold text-pink-700 text-xl">
          โครงการที่ติดลบ
        </div>

        <div className="flex-1 overflow-auto custom-scrollbar border rounded-xl">
          <table className="border-collapse w-full">
            <thead>
              {headers.map((row, r) => (
                <tr key={r}>
                  {row.map((cell, c) => (
                    <th
                      key={c}
                      style={{
                        minWidth: colWidths[c],
                        position: "sticky",
                        top: r * 48,
                        left: c === 0 ? 0 : undefined,
                        zIndex: c === 0 ? 30 : 20,
                        background: "#f8bbd0",
                        whiteSpace: "normal",
                        lineHeight: "1.25"
                      }}
                      className={`border px-3 py-2 text-sm font-bold text-center ${c===0?"sticky-shadow":""}`}
                    >
                      {cell}
                    </th>
                  ))}
                </tr>
              ))}
            </thead>

            <tbody>
              {loading ? (
                <tr><td colSpan="50" className="p-10 text-center">กำลังโหลดข้อมูล...</td></tr>
              ) : (
                body.map((row, r) => (
                  <tr key={r} className={r % 2 ? "bg-gray-50" : "bg-white"}>
                    {row.map((cell, c) => (
                      <td
                        key={c}
                        style={{
                          minWidth: colWidths[c],
                          position: c === 0 ? "sticky" : "relative",
                          left: c === 0 ? 0 : undefined,
                          background: c === 0 ? "#fff" : undefined,
                          zIndex: c === 0 ? 10 : 1,
                          whiteSpace: c === 2 ? "nowrap" : "normal"
                        }}
                        className={`border px-3 py-2 text-sm ${c===0?"font-bold sticky-shadow":""}`}
                      >
                        {cell}
                      </td>
                    ))}
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
