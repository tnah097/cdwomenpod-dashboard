/************************************************************
 * CONFIG
 ************************************************************/
const ROOT_FOLDER_ID = "1YHk3HQSoLq_4GB3jOWcVppvvWF_dF4L6";  // โฟลเดอร์จังหวัดหลัก

/************************************************************
 * ค้นหาไฟล์จังหวัด + เลขที่สัญญา
 ************************************************************/
function findContractFile(province, contractNo) {
  const root = DriveApp.getFolderById(ROOT_FOLDER_ID);

  const provFolder = root.getFoldersByName(province);
  if (!provFolder.hasNext()) throw new Error("ไม่พบโฟลเดอร์จังหวัด: " + province);

  const pf = provFolder.next();
  const files = pf.getFiles();

  while (files.hasNext()) {
    const f = files.next();
    const name = f.getName().replace(".xlsx", "").trim();

    if (name === contractNo) {
      return f;
    }
  }

  throw new Error("ไม่พบไฟล์เลขที่สัญญา: " + contractNo + " ในจังหวัด " + province);
}

/************************************************************
 * โหลดข้อมูลทะเบียนคุมลูกหนี้
 ************************************************************/
function loadInstallments(province, contractNo) {
  try {
    const file = findContractFile(province, contractNo);
    const ss = SpreadsheetApp.open(file);
    const sheet = ss.getSheetByName("ทะเบียนคุมลูกหนี้");

    if (!sheet) throw new Error("ไม่พบชีตทะเบียนคุมลูกหนี้");

    const last = sheet.getLastRow();
    const data = sheet.getRange(4, 1, last - 3, 15).getValues();

    const installments = data.map(r => ({
      sequence: r[0],
      dueDate: r[1],
      principal: r[2],
      interest: r[3],
      penalty: r[4],
      oldDefaultInterest: r[5],
      newDefaultInterest: r[6],
      receivedPrincipal: r[8],
      receivedInterest: r[9],
      receivedPenalty: r[10],
      receivedOldDefaultInterest: r[11],
      receivedNewDefaultInterest: r[12],
      overpayment: r[13]
    }));

    return { status: "success", installments };

  } catch (err) {
    return { status: "error", message: err.message };
  }
}

/************************************************************
 * บันทึกผลการตัดชำระ
 ************************************************************/
function saveInstallments(province, contractNo, installments, payAmount, payDate) {
  try {
    const file = findContractFile(province, contractNo);
    const ss = SpreadsheetApp.open(file);

    const sheetReg = ss.getSheetByName("ทะเบียนคุมลูกหนี้");
    const sheetPay = ss.getSheetByName("ตารางการรับชำระ");
    const sheetHis = ss.getSheetByName("ประวัติการรับชำระเงิน");

    if (!sheetReg || !sheetPay || !sheetHis)
      throw new Error("ชื่อชีตไม่ครบ");

    /********** 1) UPDATE ทะเบียนคุมลูกหนี้ **********/
    installments.forEach(inst => {
      const row = inst.sequence + 3;

      sheetReg.getRange(row, 9).setValue(inst.receivedPrincipal);
      sheetReg.getRange(row, 10).setValue(inst.receivedInterest);
      sheetReg.getRange(row, 11).setValue(inst.receivedPenalty);
      sheetReg.getRange(row, 12).setValue(inst.receivedOldDefaultInterest);
      sheetReg.getRange(row, 13).setValue(inst.receivedNewDefaultInterest);
      sheetReg.getRange(row, 14).setValue(inst.overpayment);

      const total =
        inst.receivedPrincipal +
        inst.receivedInterest +
        inst.receivedPenalty +
        inst.receivedOldDefaultInterest +
        inst.receivedNewDefaultInterest +
        inst.overpayment;

      sheetReg.getRange(row, 15).setValue(total);
    });

    /********** 2) ADD “ตารางการรับชำระ” **********/
    const lr = sheetPay.getLastRow() + 1;
    sheetPay.getRange(lr, 1).setValue(lr - 3);
    sheetPay.getRange(lr, 6).setValue(payAmount);
    sheetPay.getRange(lr, 8).setValue(payDate);

    /********** 3) ADD “ประวัติการรับชำระเงิน” **********/
    installments
      .filter(x => x.justPaidAmount > 0)
      .forEach(inst => {
        const r = sheetHis.getLastRow() + 1;

        sheetHis.getRange(r, 1).setValue(inst.sequence);
        sheetHis.getRange(r, 2).setValue(new Date());
        sheetHis.getRange(r, 3).setValue(payDate);
        sheetHis.getRange(r, 4).setValue(inst.principal);
        sheetHis.getRange(r, 7).setValue(inst.justPaidAmount);
      });

    return { status: "success", message: "บันทึกข้อมูลสำเร็จ" };

  } catch (err) {
    return { status: "error", message: err.message };
  }
}

/************************************************************
 * HTML
 ************************************************************/
function doGet() {
  return HtmlService.createHtmlOutputFromFile("index")
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}
