<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>โปรแกรมจัดการและตัดชำระหนี้</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif; margin: 0; padding: 20px; box-sizing: border-box;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), url('https://i.postimg.cc/507bjy9Z/cdd.png') center/cover no-repeat fixed;
      display: flex; flex-direction: column; align-items: center; gap: 30px;
    }
    .container {
      border-radius: 25px; padding: 30px; box-shadow: 0 8px 25px rgba(233, 30, 99, 0.3);
      width: 100%; max-width: 600px; box-sizing: border-box; background-color: rgba(255, 255, 255, 0.92);
    }
    .header-section {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
    }
    .header-text h1 { font-size: 2rem; font-weight: bold; margin: 0; color: navy; }
    .header-text h2 { font-size: 1.2rem; margin: 5px 0; color: deeppink; }
    .logos img { height: 60px; margin-left: 5px; }
    .calculator-card {
      background-color: #ffebf2; padding: 25px; border-radius: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }
    .input-group { display: flex; flex-direction: column; margin-bottom: 15px; }
    .input-group label { font-weight: bold; margin-bottom: 6px; color: #333; }
    .input-group input { padding: 12px; border: 2px solid #f8bbd0; border-radius: 12px; font-size: 1rem; transition: 0.3s ease; }
    .calc-button {
      width: 100%; padding: 15px; background-color: #e91e63; color: white;
      font-size: 1.3rem; font-weight: bold; border: none; border-radius: 15px;
      cursor: pointer; transition: 0.3s ease; margin-top: 10px;
    }
    .settle-button { background-color: #28a745; }
    .result-box {
      margin-top: 20px; padding: 20px; border: 3px dashed #f06292;
      border-radius: 15px; background-color: #fff8fa; text-align: center;
      font-size: 1.5rem; font-weight: bold; color: #880e4f;
    }
    .table-container {
      border-radius: 25px; padding: 30px; box-shadow: 0 8px 25px rgba(0, 81, 150, 0.3);
      width: 100%; max-width: 1200px; box-sizing: border-box; background-color: rgba(255, 255, 255, 0.95);
    }
    .table-container h1, .table-container h2 { color: navy; text-align: center; margin-bottom: 10px; }
    .upload-section {
      background-color: #e3f2fd; border: 2px dashed #0d47a1; border-radius: 15px;
      padding: 20px; text-align: center; margin-bottom: 20px;
    }
    .table-wrapper { overflow-x: auto; max-height: 500px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; white-space: nowrap; vertical-align: middle;}
    td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(9)) { text-align: right; }
    thead th { background-color: #002D62; color: white; position: sticky; top: 0; z-index: 10; }
    .status-paid { background-color: #d4edda !important; color: #155724; }
    .status-due { background-color: #f8d7da !important; color: #721c24; }
    
    .summary-table-wrapper { margin-top: 20px; overflow-x: auto; }
    .summary-table { width: 100%; }
    .summary-table th { background-color: #e9ecef; color: #495057; }
    .summary-table td:first-child { font-weight: bold; text-align: left; }
    .summary-table tr:last-child { font-weight: bold; background-color: #f8f9fa; }
    #history-table { margin-top: 15px; }
    #history-table th { background-color: #6c757d; color: white; }
  </style>
</head>
<body>

  <div class="container">
    <div class="header-section">
      <div class="header-text"><h1>ส่วนคำนวณและตัดชำระหนี้</h1><h2>เครื่องมือช่วยจัดการ</h2></div>
      <div class="logos">
        <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD Logo" />
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANdGcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Women Fund Logo" />
      </div>
    </div>
    <div class="calculator-card">
        <p style="text-align:center; font-weight:bold; color:#880e4f;">ส่วนที่ 1: เครื่องมือคำนวณ (Manual)</p>
        <div class="input-group">
            <label for="principal">เงินต้น (สำหรับคำนวณ):</label>
            <input type="text" id="principal" placeholder="กรอกเงินต้นที่ต้องการคำนวณ" onkeyup="formatNumberInput(this)">
        </div>
        <div class="input-group">
            <label for="rate">อัตราดอกเบี้ยผิดนัด (% ต่อปี):</label>
            <input type="number" id="rate" value="5" readonly>
        </div>
        <div class="input-group">
            <label for="dueDate">วันที่ครบกำหนด/วันสุดท้ายที่จ่าย:</label>
            <input type="date" id="dueDate">
        </div>
        <div class="input-group">
            <label for="paymentDateCalc">วันที่จ่ายชำระ (สำหรับคำนวณ):</label>
            <input type="date" id="paymentDateCalc">
        </div>
        <button class="calc-button" onclick="calculateInterest()">คำนวณดอกเบี้ยผิดนัด</button>
        <div id="result" class="result-box">ผลการคำนวณ: 0.00 บาท</div>
        <hr style="margin: 20px 0; border: 1px solid #f8bbd0;">
        <p style="text-align:center; font-weight:bold; color:#155724;">ส่วนที่ 2: ตัดชำระหนี้</p>
        <div class="input-group">
            <label for="paymentAmount">ระบุจำนวนเงินที่จะชำระ (ยอดเงินที่ได้รับจริง):</label>
            <input type="number" id="paymentAmount" placeholder="กรอกยอดเงินที่ได้รับจริง">
        </div>
        <div class="input-group">
            <label for="actualPaymentDate">วันที่จ่ายชำระจริง (สำหรับบันทึก):</label>
            <input type="date" id="actualPaymentDate">
        </div>
        <button class="calc-button settle-button" onclick="settlePayment()">เริ่มตัดชำระหนี้ในตาราง</button>
    </div>
  </div>

  <div class="table-container">
    <div id="history-container">
        <h2>ประวัติการตัดชำระ</h2>
        <div class="table-wrapper" style="max-height: 200px;">
            <table id="history-table">
                <thead><tr><th>วันที่ชำระ</th><th>ยอดชำระ</th><th>งวดที่</th><th>รายการที่ตัด</th><th>จำนวนเงิน</th></tr></thead>
                <tbody id="history-table-body"><tr><td colspan="5">ยังไม่มีประวัติการชำระเงิน</td></tr></tbody>
            </table>
        </div>
    </div>
    <hr style="margin: 30px 0;">
    <h1>ตารางแสดงรายละเอียดหนี้</h1>
    <div class="upload-section">
        <label for="excel-file">เลือกไฟล์ Excel (.xlsx, .xls, .csv) เพื่อแสดงข้อมูล</label>
        <input type="file" id="excel-file" accept=".xlsx, .xls, .csv">
    </div>
    <div class="table-wrapper">
        <table id="payment-table">
            <thead></thead>
            <tbody id="payment-table-body"><tr><td colspan="18" style="text-align:center; padding: 40px; color: #555;">กรุณาเลือกไฟล์ Excel...</td></tr></tbody>
        </table>
    </div>
    <div id="summary-container" class="summary-table-wrapper">
        <h2 style="margin-top: 30px;">ตารางสรุปยอดรวม</h2>
        <table class="summary-table">
            <thead><tr id="summary-table-header"></tr></thead>
            <tbody id="summary-table-body"></tbody>
        </table>
    </div>
  </div>

<script>
let allInstallments = [];
let paymentHistory = [];

const excelHeaderMapping = {
    'ลำดับ': 'sequence', 'กำหนดวันชำระเงิน': 'dueDate', 'เงินต้น': 'principal',
    'ดอกเบี้ย': 'interest', 'เบี้ยปรับ': 'penalty', 'ด/บ ผิดนัดเดิม': 'oldDefaultInterest',
    'ด/บ ผิดนัดใหม่': 'newDefaultInterest', 'รับคืนเงินต้น': 'receivedPrincipal',
    'รับคืนดอกเบี้ย': 'receivedInterest', 'รับคืนเบี้ยปรับ': 'receivedPenalty',
    'รับคืนดอกเบี้ยผิดนัดเดิม': 'receivedOldDefaultInterest',
    'รับคืนดอกเบี้ยผิดนัดใหม่': 'receivedNewDefaultInterest', 'รับเงินเกิน': 'overpayment'
};

document.getElementById('excel-file').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        if (jsonData.length === 0) { alert("ไฟล์ Excel ไม่มีข้อมูล"); return; }
        
        allInstallments = jsonData.map((row, index) => {
            let installment = { id: index };
            for (const excelHeader in excelHeaderMapping) {
                const internalKey = excelHeaderMapping[excelHeader];
                installment[internalKey] = row[excelHeader] || 0;
            }
            installment.overpayment = installment.overpayment || 0; // เริ่มต้นเงินเกินเป็น 0
            return installment;
        });
        paymentHistory = [];
        renderAll();
    };
    reader.readAsArrayBuffer(file);
}

function renderAll() {
    renderTable();
    renderHistoryTable();
    renderSummary();
}

function renderTable() {
    const tbody = document.getElementById('payment-table-body');
    const thead = document.getElementById('payment-table').querySelector('thead');
    thead.innerHTML = ''; tbody.innerHTML = '';
    const displayHeaders = [
        'ลำดับ', 'กำหนดวันชำระ', 'เงินต้น', 'ดอกเบี้ย', 'เบี้ยปรับ', 'ด/บ ผิดนัดเดิม', 'ด/บ ผิดนัดใหม่', 'รวมหนี้', 
        'รับคืน ด/บ ผิดนัดเดิม', 'รับคืน ด/บ ผิดนัดใหม่', 'รับคืนเบี้ยปรับ',
        'รับคืนดอกเบี้ย', 'รับคืนเงินต้น', 'รับคืนรวม', 'รับเงินเกิน', 'หนี้คงเหลือ', 'สถานะ'
    ];
    thead.innerHTML = `<tr><th>${displayHeaders.join('</th><th>')}</th></tr>`;

    allInstallments.forEach(inst => {
        const totalDebt = (inst.principal||0) + (inst.interest||0) + (inst.penalty||0) + (inst.oldDefaultInterest||0) + (inst.newDefaultInterest||0);
        const totalPaid = (inst.receivedOldDefaultInterest||0) + (inst.receivedNewDefaultInterest||0) + (inst.receivedPenalty||0) + (inst.receivedInterest||0) + (inst.receivedPrincipal||0);
        const remainingDebt = Math.max(0, totalDebt - totalPaid);
        let status = (remainingDebt <= 0.01) ? 'ชำระครบแล้ว' : (new Date(inst.dueDate) < new Date() ? 'ค้างชำระ' : 'ยังไม่ถึงกำหนด');
        const totalReceived = totalPaid + (inst.overpayment||0);
        const cells = [
            inst.sequence, formatDate(inst.dueDate), formatNumber(inst.principal),
            formatNumber(inst.interest), formatNumber(inst.penalty), formatNumber(inst.oldDefaultInterest),
            formatNumber(inst.newDefaultInterest), formatNumber(totalDebt),
            formatNumber(inst.receivedOldDefaultInterest), formatNumber(inst.receivedNewDefaultInterest),
            formatNumber(inst.receivedPenalty), formatNumber(inst.receivedInterest),
            formatNumber(inst.receivedPrincipal), formatNumber(totalReceived), formatNumber(inst.overpayment),
            formatNumber(remainingDebt), status
        ];
        tbody.innerHTML += `<tr><td>${cells.join('</td><td>')}</td></tr>`;
    });
    applyRowColors();
}

function renderHistoryTable() {
    const tbody = document.getElementById('history-table-body');
    tbody.innerHTML = '';
    if (paymentHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">ยังไม่มีประวัติการชำระเงิน</td></tr>';
        return;
    }
    paymentHistory.forEach(entry => {
        entry.breakdown.forEach(item => {
            tbody.innerHTML += `<tr>
                <td>${formatDate(entry.date)}</td>
                <td style="text-align:right;">${formatNumber(entry.totalAmount)}</td>
                <td>${item.sequence}</td>
                <td>${item.category}</td>
                <td style="text-align:right;">${formatNumber(item.amount)}</td>
            </tr>`;
        });
    });
}

function renderSummary() {
    const header = document.getElementById('summary-table-header');
    const tbody = document.getElementById('summary-table-body');
    header.innerHTML = ''; tbody.innerHTML = '';
    if (allInstallments.length === 0) return;

    const summaryHeaders = ['', 'เงินต้น', 'ดอกเบี้ย', 'เบี้ยปรับ', 'ด/บ ผิดนัดเดิม', 'ด/บ ผิดนัดใหม่', 'รับเงินเกิน', 'รวม'];
    header.innerHTML = `<th>${summaryHeaders.join('</th><th>')}</th>`;

    const totals = {
        due: { principal: 0, interest: 0, penalty: 0, oldDefaultInterest: 0, newDefaultInterest: 0, overpayment:0, total: 0 },
        received: { principal: 0, interest: 0, penalty: 0, oldDefaultInterest: 0, newDefaultInterest: 0, overpayment:0, total: 0 }
    };

    allInstallments.forEach(inst => {
        totals.due.principal += inst.principal || 0;
        totals.due.interest += inst.interest || 0;
        totals.due.penalty += inst.penalty || 0;
        totals.due.oldDefaultInterest += inst.oldDefaultInterest || 0;
        totals.due.newDefaultInterest += inst.newDefaultInterest || 0;
        totals.received.principal += inst.receivedPrincipal || 0;
        totals.received.interest += inst.receivedInterest || 0;
        totals.received.penalty += inst.receivedPenalty || 0;
        totals.received.oldDefaultInterest += inst.receivedOldDefaultInterest || 0;
        totals.received.newDefaultInterest += inst.receivedNewDefaultInterest || 0;
        totals.received.overpayment += inst.overpayment || 0;
    });

    totals.due.total = totals.due.principal + totals.due.interest + totals.due.penalty + totals.due.oldDefaultInterest + totals.due.newDefaultInterest;
    totals.received.total = totals.received.principal + totals.received.interest + totals.received.penalty + totals.received.oldDefaultInterest + totals.received.newDefaultInterest + totals.received.overpayment;

    const remaining = {
        principal: Math.max(0, totals.due.principal - totals.received.principal),
        interest: Math.max(0, totals.due.interest - totals.received.interest),
        penalty: Math.max(0, totals.due.penalty - totals.received.penalty),
        oldDefaultInterest: Math.max(0, totals.due.oldDefaultInterest - totals.received.oldDefaultInterest),
        newDefaultInterest: Math.max(0, totals.due.newDefaultInterest - totals.received.newDefaultInterest),
        overpayment: 0,
        total: Math.max(0, totals.due.total - (totals.received.total - totals.received.overpayment))
    };
    
    tbody.innerHTML = `
        <tr><td>กรอบวงเงิน</td>${Object.values(totals.due).map(val => `<td>${formatNumber(val)}</td>`).join('')}</tr>
        <tr><td>รับชำระ</td>${Object.values(totals.received).map(val => `<td>${formatNumber(val)}</td>`).join('')}</tr>
        <tr><td>คงเหลือ</td>${Object.values(remaining).map(val => `<td>${formatNumber(val)}</td>`).join('')}</tr>
    `;
}

function calculateInterest() {
    const principalRaw = document.getElementById('principal').value.replace(/,/g, '');
    const principal = parseFloat(principalRaw);
    const rate = parseFloat(document.getElementById('rate').value);
    const dueDateStr = document.getElementById('dueDate').value;
    const paymentDateStr = document.getElementById('paymentDateCalc').value;
    const resultBox = document.getElementById('result');
    if (!principal || !rate || !dueDateStr || !paymentDateStr) {
        resultBox.innerHTML = "⚠️ โปรดกรอกข้อมูลสำหรับคำนวณให้ครบ"; return;
    }
    const dueDate = new Date(dueDateStr), paymentDate = new Date(paymentDateStr);
    const days = Math.max(0, Math.floor((paymentDate - dueDate) / (1000 * 60 * 60 * 24)));
    const interest = (principal * (rate / 100) * days) / 365;
    resultBox.innerHTML = `ผลการคำนวณ: ${interest.toFixed(2)} บาท (${days} วัน)`;
}

function settlePayment() {
    let paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    const actualPaymentDate = document.getElementById('actualPaymentDate').value;
    if (isNaN(paymentAmount) || paymentAmount <= 0) { alert("กรุณาใส่จำนวนเงินที่จะชำระให้ถูกต้อง"); return; }
    if (!actualPaymentDate) { alert("กรุณาระบุ 'วันที่จ่ายชำระจริง' ก่อน"); return; }
    if (allInstallments.length === 0) { alert("กรุณาอัปโหลดไฟล์ Excel ก่อน"); return; }

    const dueInstallments = allInstallments.filter(inst => {
        const totalDebt = (inst.principal||0)+(inst.interest||0)+(inst.penalty||0)+(inst.oldDefaultInterest||0)+(inst.newDefaultInterest||0);
        const totalPaid = (inst.receivedOldDefaultInterest||0)+(inst.receivedNewDefaultInterest||0)+(inst.receivedPenalty||0)+(inst.receivedInterest||0)+(inst.receivedPrincipal||0)+(inst.overpayment||0);
        return totalDebt - totalPaid > 0.01;
    }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

    if (dueInstallments.length === 0) { alert("ไม่พบหนี้ค้างชำระ"); return; }
    
    let historyEntry = { date: new Date(actualPaymentDate), totalAmount: paymentAmount, breakdown: [] };
    let lastPaidInstallment = null;

    for (let inst of dueInstallments) {
        if (paymentAmount <= 0) break;

        const pay = (dueAmount, receivedKey, categoryName) => {
            if (paymentAmount > 0 && dueAmount > 0) {
                const amountToPay = Math.min(paymentAmount, dueAmount);
                inst[receivedKey] = Math.floor(((inst[receivedKey] || 0) + amountToPay) * 100) / 100;
                paymentAmount -= amountToPay;
                historyEntry.breakdown.push({ sequence: inst.sequence, category: categoryName, amount: amountToPay });
                lastPaidInstallment = inst;
            }
        };
        
        // ตัด ด/บ ผิดนัดเดิม
        let dueOldInterest = (inst.oldDefaultInterest || 0) - (inst.receivedOldDefaultInterest || 0);
        pay(dueOldInterest, 'receivedOldDefaultInterest', 'ด/บ ผิดนัดเดิม');

        // คำนวณ ด/บ ผิดนัดใหม่ สด ๆ
        const lastPayment = new Date(inst.lastPaymentDate || inst.dueDate);
        const currentPaymentDate = new Date(actualPaymentDate);
        const daysOverdue = Math.max(0, Math.floor((currentPaymentDate - lastPayment) / (1000 * 60 * 60 * 24)));
        const remainingPrincipal = (inst.principal || 0) - (inst.receivedPrincipal || 0);
        
        let dueNewInterest = 0;
        if (remainingPrincipal > 0 && daysOverdue > 0) {
             dueNewInterest = (remainingPrincipal * (5 / 100) * daysOverdue) / 365;
        }
        inst.newDefaultInterest = (inst.newDefaultInterest || 0) + dueNewInterest;
        pay(dueNewInterest, 'receivedNewDefaultInterest', 'ด/บ ผิดนัดใหม่');

        // ตัดเบี้ยปรับ
        let duePenalty = (inst.penalty || 0) - (inst.receivedPenalty || 0);
        pay(duePenalty, 'receivedPenalty', 'เบี้ยปรับ');

        // ตัดดอกเบี้ย
        let dueInterest = (inst.interest || 0) - (inst.receivedInterest || 0);
        pay(dueInterest, 'receivedInterest', 'ดอกเบี้ย');

        // ตัดเงินต้น
        let duePrincipal = (inst.principal || 0) - (inst.receivedPrincipal || 0);
        pay(duePrincipal, 'receivedPrincipal', 'เงินต้น');
    }
    
    if (paymentAmount > 0) {
        if(lastPaidInstallment) {
            lastPaidInstallment.overpayment = (lastPaidInstallment.overpayment || 0) + paymentAmount;
            alert(`ตัดชำระหนี้ทั้งหมดแล้ว และบันทึกเงินเกินจำนวน ${formatNumber(paymentAmount)} บาท ในงวดล่าสุดที่ชำระ`);
        } else {
            alert(`ตัดชำระหนี้ทั้งหมดแล้ว ยังมีเงินเหลือ: ${formatNumber(paymentAmount)} บาท`);
        }
    }
    
    if (historyEntry.breakdown.length > 0) {
        paymentHistory.push(historyEntry);
        historyEntry.breakdown.forEach(item => {
            const installment = allInstallments.find(i => i.sequence === item.sequence);
            if (installment) installment.lastPaymentDate = historyEntry.date;
        });
    }
    renderAll();
    document.getElementById('paymentAmount').value = '';
}

function applyRowColors() {
    document.querySelectorAll("#payment-table-body tr").forEach(row => {
        const status = row.cells[16]?.textContent.trim();
        row.className = '';
        if (status === "ชำระครบแล้ว") row.classList.add('status-paid');
        else if (status === "ค้างชำระ") row.classList.add('status-due');
    });
}

function formatNumber(num) { return (typeof num === 'number') ? num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00'; }
function formatDate(dateStr) {
    if (!dateStr || isNaN(new Date(dateStr).getTime())) return '';
    return new Date(dateStr).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
}
function formatNumberInput(input) {
    let value = input.value.replace(/,/g, '');
    if (!isNaN(value) && value.length > 0) {
        input.value = parseFloat(value).toLocaleString('en-US');
    }
}
</script>
</body>
</html>
