<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>โปรแกรมจัดการและตัดชำระหนี้</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0; padding: 20px; box-sizing: border-box;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), 
      url('https://i.postimg.cc/507bjy9Z/cdd.png') center/cover no-repeat fixed;
      display: flex; flex-direction: column; align-items: center; gap: 30px;
    }
    .container {
      border-radius: 25px; padding: 30px;
      box-shadow: 0 8px 25px rgba(233, 30, 99, 0.3);
      width: 100%; max-width: 600px; box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.92);
    }
    .header-section {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
    }
    .header-text h1 { font-size: 2rem; font-weight: bold; margin: 0; color: navy; }
    .header-text h2 { font-size: 1.2rem; margin: 5px 0; color: deeppink; }
    .logos img { height: 60px; margin-left: 5px; }
    .calculator-card {
      background-color: #ffebf2; padding: 25px; border-radius: 20px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }
    .input-group { display: flex; flex-direction: column; margin-bottom: 15px; }
    .input-group label { font-weight: bold; margin-bottom: 6px; color: #333; }
    .input-group input { padding: 12px; border: 2px solid #f8bbd0; border-radius: 12px; font-size: 1rem; transition: 0.3s ease; }
    .calc-button {
      width: 100%; padding: 15px; background-color: #e91e63; color: white;
      font-size: 1.3rem; font-weight: bold; border: none; border-radius: 15px;
      cursor: pointer; transition: 0.3s ease; margin-top: 10px;
    }
    .settle-button { background-color: #28a745; }
    .result-box {
      margin-top: 20px; padding: 20px; border: 3px dashed #f06292;
      border-radius: 15px; background-color: #fff8fa; text-align: center;
      font-size: 1.5rem; font-weight: bold; color: #880e4f;
    }
    .table-container {
      border-radius: 25px; padding: 30px;
      box-shadow: 0 8px 25px rgba(0, 81, 150, 0.3);
      width: 100%; max-width: 1200px; box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.95);
    }
    .upload-section {
      background-color: #e3f2fd; border: 2px dashed #0d47a1; border-radius: 15px;
      padding: 20px; text-align: center; margin-bottom: 20px;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
    td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(9)) { text-align: right; }
    thead th { background-color: #002D62; color: white; position: sticky; top: 0; }
    .status-paid { background-color: #d4edda !important; color: #155724; }
    .status-due { background-color: #f8d7da !important; color: #721c24; }
    .summary-table th { background-color: #e9ecef; color: #495057; }
    .summary-table td:first-child { font-weight: bold; text-align: left; }
    #history-table th { background-color: #6c757d; color: white; }
  </style>
</head>

<body>

  <div class="container">
    <div class="header-section">
      <div class="header-text">
        <h1>ส่วนคำนวณและตัดชำระหนี้</h1>
        <h2>เครื่องมือช่วยจัดการ</h2>
      </div>
      <div class="logos">
        <img src="https://i.postimg.cc/507bjy9Z/cdd.png" />
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANdGcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" />
      </div>
    </div>

    <div class="calculator-card">
      <p style="text-align:center; font-weight:bold; color:#880e4f;">ส่วนที่ 1: เครื่องมือคำนวณดอกเบี้ยผิดนัด</p>
      <div class="input-group">
        <label for="principal">เงินต้น (บาท):</label>
        <input type="text" id="principal" placeholder="กรอกเงินต้น" onkeyup="formatNumberInput(this)">
      </div>
      <div class="input-group">
        <label for="rate">อัตราดอกเบี้ยผิดนัด (% ต่อปี):</label>
        <input type="number" id="rate" value="5" readonly>
      </div>
      <div class="input-group">
        <label for="dueDate">วันที่ครบกำหนด:</label>
        <input type="date" id="dueDate">
      </div>
      <div class="input-group">
        <label for="paymentDateCalc">วันที่จ่ายชำระจริง:</label>
        <input type="date" id="paymentDateCalc">
      </div>
      <button class="calc-button" onclick="calculateInterest()">คำนวณดอกเบี้ยผิดนัด</button>
      <div id="result" class="result-box">ผลการคำนวณ: 0.00 บาท</div>

      <hr style="margin: 20px 0; border: 1px solid #f8bbd0;">
      <p style="text-align:center; font-weight:bold; color:#155724;">ส่วนที่ 2: ตัดชำระหนี้</p>
      <div class="input-group">
        <label for="paymentAmount">จำนวนเงินที่จะชำระ (บาท):</label>
        <input type="number" id="paymentAmount" placeholder="กรอกยอดเงินที่ได้รับจริง">
      </div>
      <div class="input-group">
        <label for="actualPaymentDate">วันที่ชำระจริง:</label>
        <input type="date" id="actualPaymentDate">
      </div>
      <button class="calc-button settle-button" onclick="settlePayment()">เริ่มตัดชำระหนี้</button>
    </div>
  </div>

  <div class="table-container">
    <h2>ประวัติการตัดชำระ</h2>
    <table id="history-table">
      <thead><tr><th>วันที่ชำระ</th><th>ยอดชำระ</th><th>งวดที่</th><th>รายการ</th><th>จำนวนเงิน</th><th>วันเกินกำหนด</th></tr></thead>
      <tbody id="history-table-body"><tr><td colspan="6">ยังไม่มีข้อมูล</td></tr></tbody>
    </table>
  </div>

  <div class="table-container">
    <h1>นำเข้าไฟล์ข้อมูลงวดชำระ</h1>
    <div class="upload-section">
      <input type="file" id="excel-file" accept=".xlsx,.xls,.csv">
    </div>
    <table id="payment-table">
      <thead></thead>
      <tbody id="payment-table-body"><tr><td colspan="16" style="text-align:center;">กรุณาเลือกไฟล์ Excel...</td></tr></tbody>
    </table>
    <h2>สรุปยอดรวม</h2>
    <table class="summary-table">
      <thead><tr id="summary-table-header"></tr></thead>
      <tbody id="summary-table-body"></tbody>
    </table>
  </div>

<script>
let allInstallments = [
  { sequence: 1, dueDate: '2025-09-10', principal: 10000, receivedPrincipal: 0 },
  { sequence: 2, dueDate: '2025-10-10', principal: 8000, receivedPrincipal: 0 }
];
let paymentHistory = [];

// --- ส่วนคำนวณดอกเบี้ยผิดนัด ---
function calculateInterest() {
  const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, '')) || 0;
  const rate = parseFloat(document.getElementById('rate').value) || 0;
  const dueDate = new Date(document.getElementById('dueDate').value);
  const payDate = new Date(document.getElementById('paymentDateCalc').value);

  if (!principal || !dueDate || !payDate) return alert('กรุณากรอกข้อมูลให้ครบ');
  const daysLate = Math.max(0, Math.floor((payDate - dueDate) / (1000 * 60 * 60 * 24)));
  const interest = principal * (rate / 100) * (daysLate / 365);
  document.getElementById('result').innerText = `ผลการคำนวณ: ${formatNumber(interest)} บาท (เกิน ${daysLate} วัน)`;
}

// --- ส่วนตัดชำระหนี้ ---
function settlePayment() {
  let paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
  const actualPaymentDate = document.getElementById('actualPaymentDate').value;
  if (isNaN(paymentAmount) || paymentAmount <= 0) return alert("กรุณากรอกยอดชำระให้ถูกต้อง");
  if (!actualPaymentDate) return alert("กรุณาเลือกวันที่ชำระ");

  const dueInstallments = allInstallments.filter(inst => (inst.principal - inst.receivedPrincipal) > 0);
  let historyEntry = { date: new Date(actualPaymentDate), totalAmount: paymentAmount, breakdown: [] };

  for (let inst of dueInstallments) {
    if (paymentAmount <= 0) break;
    const remain = inst.principal - inst.receivedPrincipal;
    const paid = Math.min(paymentAmount, remain);
    inst.receivedPrincipal += paid;
    paymentAmount -= paid;
    const daysOver = Math.max(0, Math.floor((new Date(actualPaymentDate) - new Date(inst.dueDate)) / (1000*60*60*24)));
    historyEntry.breakdown.push({ sequence: inst.sequence, category: "เงินต้น", amount: paid, daysOverdue: daysOver });
  }
  paymentHistory.push(historyEntry);
  renderHistoryTable();
  document.getElementById('paymentAmount').value = '';
}

function renderHistoryTable() {
  const tbody = document.getElementById('history-table-body');
  tbody.innerHTML = '';
  if (paymentHistory.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6">ยังไม่มีประวัติการชำระเงิน</td></tr>';
    return;
  }
  paymentHistory.forEach(entry => {
    entry.breakdown.forEach(item => {
      tbody.innerHTML += `
        <tr>
          <td>${formatDate(entry.date)}</td>
          <td>${formatNumber(entry.totalAmount)}</td>
          <td>${item.sequence}</td>
          <td>${item.category}</td>
          <td>${formatNumber(item.amount)}</td>
          <td>${item.daysOverdue} วัน</td>
        </tr>`;
    });
  });
}

// --- ส่วนอัปโหลด Excel ---
document.getElementById('excel-file').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const data = new Uint8Array(ev.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet);
    renderExcelTable(rows);
  };
  reader.readAsArrayBuffer(file);
});

function renderExcelTable(rows) {
  const thead = document.querySelector('#payment-table thead');
  const tbody = document.getElementById('payment-table-body');
  if (rows.length === 0) return;

  const headers = Object.keys(rows[0]);
  thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
  tbody.innerHTML = rows.map(r => `<tr>${headers.map(h => `<td>${r[h]||''}</td>`).join('')}</tr>`).join('');
}

// --- ฟังก์ชันทั่วไป ---
function formatNumber(num){ return Number(num).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function formatDate(date){ return new Date(date).toLocaleDateString('th-TH',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function formatNumberInput(el){ el.value = el.value.replace(/[^\d.]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
</script>
</body>
</html>
