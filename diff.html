<!DOCTYPE html>
<html lang="th">
<head>

   
    
<meta charset="UTF-8" />

     <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
<title>Dashboard ตรวจสอบคอลัมน์ U</title>

<style>



   #loadingBox {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #ffb6d9;
    padding: 15px 25px;
    border-radius: 12px;
    box-shadow: 0px 3px 10px rgba(0,0,0,0.2);
    text-align: center;
    z-index: 9999;
    color: #7a0052;
    font-weight: bold;
    font-size: 18px;
}

/* ลูกศรหมุน */
.loading-arrow {
    font-size: 28px;
    animation: spin 1s linear infinite;
    margin-bottom: 5px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


   
    body {
        font-family: Kanit, sans-serif;
        margin: 0;
        background: #fdeefa;
        color: #333;
    }

    header {
        background: #ffb6d9;
        padding: 20px;
        text-align: center;
        font-size: 26px;
        font-weight: bold;
        color: #7a0052;
        box-shadow: 0px 2px 4px rgba(0,0,0,0.15);
    }

    .container {
        padding: 20px;
        max-width: 1100px;
        margin: auto;
    }

    .card {
        background: #fff;
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 25px;
        border-left: 8px solid #ff99c8;
    }

    label {
        font-size: 18px;
        font-weight: 600;
    }

    select, button {
        padding: 10px 15px;
        font-size: 16px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid #ff8fc2;
    }

    button {
        background: #ff8fc2;
        color: white;
        cursor: pointer;
        font-weight: bold;
    }

    button:hover {
        background: #ff73b8;
    }

    table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
        font-size: 15px;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #ffd3e6;
        text-align: center;
    }

    th {
        background: #ffb6d9;
        color: #7a0052;
        font-weight: 700;
    }

    .highlight {
        background: #ffe6f2;
        font-weight: bold;
        color: #d10063;
    }

    canvas {
        margin-top: 20px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
    Dashboard ตรวจสอบความต่างคอลัมน์ V (KPI69 Vs นย04)
</header>

<div class="container">

    <!-- เลือกจังหวัด -->
    <div class="card">
        <label>เลือกจังหวัด:</label>
        <select id="provinceSelect">
            <option value="">กำลังโหลดจังหวัด...</option>
        </select>
        <br><br>
        <button onclick="loadData()">โหลดข้อมูล</button>
    </div>

    <!-- ตารางผลตรวจสอบ -->
    <div class="card">
        <h2>ผลตรวจสอบเลขที่สัญญา (คอลัมน์ V ต่างกัน)</h2>

        <table id="resultTable">
            <thead>
                <tr>
                    <th>เลขที่สัญญา</th>
                    <th>V ใน KPI69</th>
                    <th>V รวมจาก นย04</th>
                    <th>ผลต่าง</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- กราฟ -->
    <div class="card">
        <h2>สรุปจำนวนความต่าง</h2>
        <canvas id="barChart" height="80"></canvas>
    </div>

</div>

<script>
// API URL ของตัวเอง
const API_URL = "https://script.google.com/macros/s/AKfycbwLHaiCrBuexYAA8l012cCO46O3RnK3pzWYsejj98kc3XjM1gE7Cs9kXGo1XqbZPmaM/exec";

// โหลดรายชื่อจังหวัดอัตโนมัติเมื่อหน้าเว็บเปิดขึ้น
window.onload = loadProvinces;

// ดึงจังหวัดทั้งหมดจาก API
async function loadProvinces() {
    showLoading();
    const select = document.getElementById("provinceSelect");

    try {
        const response = await fetch(`${API_URL}?listProvinces=1`);
        const provinces = await response.json();

        select.innerHTML = `<option value="">-- เลือกจังหวัด --</option>`;
        provinces.forEach(p => {
            const option = document.createElement("option");
            option.value = p;
            option.textContent = p;
            select.appendChild(option);
        });
    } catch (error) {
        select.innerHTML = `<option value="">โหลดจังหวัดไม่สำเร็จ</option>`;
    }

    hideLoading();
}


// โหลดข้อมูลความต่างคอลัมน์ V ของจังหวัด
async function loadData() {
    const province = document.getElementById("provinceSelect").value;

    if (!province) {
        alert("กรุณาเลือกจังหวัดก่อนนะครับ");
        return;
    }

    showLoading();

    const response = await fetch(`${API_URL}?province=${province}`);
    const data = await response.json();

    renderTable(data);
    renderChart(data);

    hideLoading();
}



// แสดงตารางผลลัพธ์
function renderTable(data) {
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";

    const filtered = data.filter(r => {
        const kpiVal = Number(r.kpi || 0);
        const nyVal  = Number(r.ny  || 0);
        const diffVal = Number(r.diff || 0);
        const noteVal = (r.note || "").trim();

        // แสดงเฉพาะแถวที่มีข้อมูลจริง หรือมีความต่าง
        return (kpiVal !== 0 || nyVal !== 0 || diffVal !== 0 || noteVal !== "");
    });

    filtered.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="highlight">${row.contract}</td>
            <td>${row.kpi}</td>
            <td>${row.ny}</td>
            <td><b>${row.diff}</b></td>
        `;
        tbody.appendChild(tr);
    });
}




function showLoading() {
    document.getElementById("loadingBox").style.display = "block";
}

function hideLoading() {
    document.getElementById("loadingBox").style.display = "none";
}
   

// แสดงกราฟแท่ง
function renderChart(data) {
    const ctx = document.getElementById("barChart");

    const filtered = data.filter(r => {
        const kpiVal = Number(r.kpi || 0);
        const nyVal  = Number(r.ny  || 0);
        const diffVal = Number(r.diff || 0);
        const noteVal = (r.note || "").trim();

        return (kpiVal !== 0 || nyVal !== 0 || diffVal !== 0 || noteVal !== "");
    });

    const labels = filtered.map(r => r.contract);
    const diffs  = filtered.map(r => Number(r.diff || 0));

    new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "ผลต่างค่า V ต่อเลขที่สัญญา",
                data: diffs,
                backgroundColor: "#ff99c8",
                borderColor: "#e3548a",
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}





   
</script>

<div id="loadingBox">
    <div class="loading-arrow">⟳</div>
    <div class="loading-text">กำลังโหลดข้อมูล...</div>
</div>

   
</body>
</html>


