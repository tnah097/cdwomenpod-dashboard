<!DOCTYPE html>
<html lang="th">
<head> 
  <meta charset="UTF-8" />
  <title>CDD Women Fund Province 2569</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />
  <style>
    body { font-family:'Sarabun',sans-serif;margin:0;background:linear-gradient(to bottom right,#fce4ec,#f3e5f5);color:#000; }
    .dashboard-container { padding:40px;background-color:rgba(255,255,255,0.95);width:100%;min-height:100vh;box-sizing:border-box; }
    .header { display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap; }
    .header-text h1 { margin:0;font-size:2.5rem; }
    .header-text h2 { margin:0;font-size:1.5rem; }
    .cards { display:flex;gap:20px;margin-top:30px;flex-wrap:wrap; }
    .card { flex:1;min-width:200px;padding:20px;border-radius:12px;color:white;font-weight:bold; }
    .card .value { font-size:1.75rem;color:black;margin-top:10px;font-weight:normal;white-space:nowrap; }
    .pink { background-color:#e91e63; }
    .light-pink { background-color:#f8bbd0; }
    .orange { background-color:#ff9800; }
    .deep-pink { background-color:#f06292; }
    table.dataTable { width:100%!important;border-collapse:collapse;font-size:0.85rem;color:black; }
    table.dataTable th,table.dataTable td { border:1px solid #ccc;padding:4px 6px;text-align:center;vertical-align:middle;white-space:nowrap; }
    table.dataTable thead th { background-color:#f06292;color:black;font-weight:bold; }
    .filter-container { display:flex;flex-wrap:wrap;align-items:flex-end;gap:15px;padding:15px;background-color:#f8bbd0;border-radius:8px;margin-bottom:20px;margin-top:20px; }
    .filter-item { display:flex;flex-direction:column;min-width:160px;flex-grow:1; }
    .filter-item label { font-weight:bold;font-size:0.8rem;margin-bottom:4px;color:#333; }
    .filter-item select { width:100%;padding:6px;border:1px solid #aaa;border-radius:4px;font-family:'Sarabun',sans-serif;font-size:0.85rem;height:35px; }
    .action-button-container { display:flex;gap:10px; }
    button { padding:6px 15px;border:none;border-radius:4px;color:white;font-weight:bold;cursor:pointer; }
    #btnResetFilter { background-color:#d9534f; }
    #btnDownload { background-color:#5cb85c; }
  </style>
</head>

<body>
<div class="dashboard-container">
  <div class="header">
    <div class="header-text">
      <h1><span style="color:navy;">CDD</span> 
          <span style="color:deeppink;">Women</span> 
          <span style="color:red;">Fund</span></h1>
      <h2>
        <span style="color:black;">รายจังหวัด:</span> 
        <span style="color:red;" id="province-title"></span>
      </h2>
    </div>
    <div class="logo-container">
      <img src="https://i.postimg.cc/507bjy9Z/cdd.png" width="60" height="100" />
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" width="70" height="100" />
    </div>
  </div>

  <div style="text-align:right;font-weight:bold;color:navy;margin-top:1rem;font-size:1.2rem;">
    <span id="update-date"></span>
  </div>

  <!-- Summary Cards -->
  <div class="cards">
    <div class="card pink">จำนวนโครงการ<div class="value" id="num-projects">-</div></div>
    <div class="card light-pink">เงินอนุมัติ<div class="value" id="approved-money">-</div></div>
    <div class="card orange">
      ลูกหนี้คงเหลือต้นปี<div class="value" id="debt-start">-</div>
      ลูกหนี้คงเหลือปัจจุบัน<div class="value" id="debt-now">-</div>
    </div>
    <div class="card deep-pink">
      หนี้เกินกำหนด<div class="value" id="overdue">-</div>
      ร้อยละ<div class="value" id="percent-overdue">-</div>
    </div>
    <div class="card deep-pink">ดำเนินคดี<div class="value" id="legal">-</div></div>
  </div>

  <h3>ตัวกรองข้อมูล</h3>
  <div id="filter-section" class="filter-container"></div>

  <h3>ตารางรายละเอียดข้อมูลโครงการรายอำเภอ</h3>
  <div style="width:100%; overflow-x:auto;">
    <table id="detailsTable" class="display" style="width:100%">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwwxjRdiPSd7SOuZAOO5OmWi5NHCBMOf3d1923ik9QBY7iiZ0gJl6ppcQQUHGrxuLRTAg/exec";
let allData = [];
let dataTable;

$(async function () {
  const province = new URLSearchParams(window.location.search).get("province");
  $("#province-title").text(province || "-");

  const res = await fetch(`${API_URL}?province=${encodeURIComponent(province)}`);
  const json = await res.json();

  allData = json.data || [];
  updateSummaryCards(json.summary);

  renderTable(allData);
  setupFilters(allData);
});

function renderTable(data) {
  const headers = Object.keys(data[0] || {});
  $("#detailsTable thead").html(
    `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`
  );

  dataTable = $("#detailsTable").DataTable({
    destroy: true,
    data: data,
    columns: headers.map(h => ({
      data: h,
      name: h,
      render: (v, t, r, m) => h === "ลำดับ" ? m.row + 1 : (v ?? "-")
    })),
    scrollX: true,
    fixedHeader: true,
    pageLength: 10,
    language: {
      search: "ค้นหา:",
      info: "แสดง _START_ ถึง _END_ จาก _TOTAL_"
    }
  });
}

function setupFilters(data) {
  const keys = ["อำเภอ/เขต", "ตำบล", "ปีงบประมาณ", "สถานะโครงการ"];
  const container = $("#filter-section").empty();

  keys.forEach(k => {
    const values = [...new Set(data.map(r => r[k]).filter(Boolean))].sort();
    container.append(`
      <div class="filter-item">
        <label>${k}</label>
        <select data-key="${k}">
          <option value="">-- ทั้งหมด --</option>
          ${values.map(v => `<option value="${v}">${v}</option>`).join("")}
        </select>
      </div>
    `);
  });

  $("#filter-section select").on("change", applyFilters);
}

function applyFilters() {
  dataTable.columns().search("");

  $("#filter-section select").each(function () {
    const key = $(this).data("key");
    const val = $(this).val();
    if (!val) return;

    const colIndex = dataTable
      .columns()
      .indexes()
      .filter(i => dataTable.settings()[0].aoColumns[i].name === key)[0];

    if (colIndex !== undefined) {
      dataTable.column(colIndex).search(`^${val}$`, true, false);
    }
  });

  dataTable.draw();
}

function updateSummaryCards(s) {
  if (!s) return;
  $("#num-projects").text(s.totalProjects?.toLocaleString("th-TH") || "-");
  $("#approved-money").text(s.approvedMoney?.toLocaleString("th-TH") || "-");
  $("#debt-start").text(s.debtStart?.toLocaleString("th-TH") || "-");
  $("#debt-now").text(s.debtNow?.toLocaleString("th-TH") || "-");
  $("#overdue").text(s.overdue?.toLocaleString("th-TH") || "-");
  $("#legal").text(s.legal?.toLocaleString("th-TH") || "-");
  $("#percent-overdue").text(s.percentOverdue ? s.percentOverdue + "%" : "-");
  $("#update-date").text("ข้อมูล ณ วันที่ " + s.updateDate);
}
</script>
</body>
</html>
