<!DOCTYPE html>
<html lang="th">
<head> 
  <meta charset="UTF-8" />
  <title>CDD Women Fund Province 2569</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
  <style>
    body { font-family:'Sarabun',sans-serif;margin:0;background:linear-gradient(to bottom right,#fce4ec,#f3e5f5);color:#000; }
    .dashboard-container { padding:40px;background-color:rgba(255,255,255,0.95);width:100%;min-height:100vh;box-sizing:border-box; }
    .header { display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap; }
    .header-text h1 { margin:0;font-size:2.5rem; }
    .header-text h2 { margin:0;font-size:1.5rem; }
    .cards { display:flex;gap:20px;margin-top:30px;flex-wrap:wrap; }
    .card { flex:1;min-width:200px;padding:20px;border-radius:12px;color:white;font-weight:bold; }
    .card .value { font-size:1.75rem;color:black;margin-top:10px;font-weight:normal;white-space:nowrap; }
    .pink { background-color:#e91e63; } .light-pink { background-color:#f8bbd0; } 
    .orange { background-color:#ff9800; } .pastel-pink { background-color:#ff4081; }
    .deep-pink { background-color:#f06292; }
    table.dataTable { width:100%!important;border-collapse:collapse;font-size:0.85rem;color:black; }
    table.dataTable th,table.dataTable td { border:1px solid #ccc;padding:4px 6px;text-align:center;vertical-align:middle;white-space:nowrap; }
    table.dataTable thead th { background-color:#f06292;color:black;font-weight:bold; }
    .filter-container { display:flex;flex-wrap:wrap;align-items:flex-end;gap:15px;padding:15px;background-color:#f8bbd0;border-radius:8px;margin-bottom:20px;margin-top:20px; }
    .filter-item { display:flex;flex-direction:column;min-width:160px;flex-grow:1; }
    .filter-item label { font-weight:bold;font-size:0.8rem;margin-bottom:4px;color:#333; }
    .filter-item select { width:100%;padding:6px;border:1px solid #aaa;border-radius:4px;font-family:'Sarabun',sans-serif;font-size:0.85rem;height:35px; }
    .action-button-container { display:flex;gap:10px; }
    button { padding:6px 15px;border:none;border-radius:4px;color:white;font-weight:bold;cursor:pointer; }
    #btnResetFilter { background-color:#d9534f; } #btnDownload { background-color:#5cb85c; }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <div class="header">
      <div class="header-text">
        <h1><span style="color:navy;">CDD</span> <span style="color:deeppink;">Women</span> <span style="color:red;">Fund</span></h1>
        <h2><span style="color:black;">‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span> <span style="color:red;" id="province-title"></span></h2>
      </div>
      <img src="https://i.postimg.cc/507bjy9Z/cdd.png" alt="CDD Logo" width="90" />
    </div>

    <div style="text-align:right;font-weight:bold;color:navy;margin-top:1rem;font-size:1.2rem;">
      <span id="update-date">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -</span>
    </div>

    <!-- ‚úÖ Summary Cards -->
    <div class="cards">
      <div class="card pink">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£<div class="value" id="num-projects">-</div>
        ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<div class="value" id="approved-money">-</div>
        ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568<div class="value" id="debt-start">-</div>
      </div>
      <div class="card light-pink">
        ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô<div class="value" id="debt-now">-</div>
        ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô<div class="value" id="recovered">-</div>
        ‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞<div class="value" id="not-due">-</div>
      </div>
      <div class="card orange">
        ‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ<div class="value" id="mediation">-</div>
        ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á<div class="value" id="prosecutor">-</div>
        ‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á<div class="value" id="court-filed">-</div>
      </div>
      <div class="card pastel-pink">
        ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢<div class="value" id="legal">-</div>
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£<div class="value" id="overdue-legal">-</div>
      </div>
      <div class="card deep-pink">
        ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞<div class="value" id="overdue">-</div>
        ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î<div class="value" id="percent-overdue">-</div>
      </div>
    </div>

    <h3>üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
    <div id="filter-section" class="filter-container"></div>

    <div class="filter-container">
      <div class="filter-item">
        <label for="downloadType">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
        <select id="downloadType"><option value="excel">Excel</option></select>
      </div>
      <div class="action-button-container">
        <button id="btnDownload">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        <button id="btnResetFilter">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
      </div>
    </div>

    <table id="detailsTable" class="display" style="width:100%">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

 <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwwxjRdiPSd7SOuZAOO5OmWi5NHCBMOf3d1923ik9QBY7iiZ0gJl6ppcQQUHGrxuLRTAg/exec";
  let allData = [], dataTable;

  const formatNumber = v => isNaN(parseFloat(v)) ? "-" : parseFloat(v).toLocaleString("th-TH", { minimumFractionDigits: 2 });
  const formatPercent = v => isNaN(parseFloat(v)) ? "-" : `${parseFloat(v).toFixed(2)}%`;
  const formatDate = v => (!v || v === "-") ? "-" : new Date(v).toLocaleDateString("th-TH");

  $(document).ready(async function () {
    const province = new URLSearchParams(window.location.search).get("province");
    $("#province-title").text(province || "-");

    $("#btnResetFilter").on("click", () => { $("#filter-section select").val("").trigger("change"); });
    $("#btnDownload").on("click", downloadData);

    await fetchData(province);
  });

  async function fetchData(province) {
    try {
      const res = await fetch(`${API_URL}?province=${encodeURIComponent(province)}`);
      const json = await res.json();
      if (json.error) throw new Error(json.error);

      allData = json.data || [];
      updateSummaryCards(json.summary);
      
      // üîπ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏•‡∏≥‡∏î‡∏±‡∏ö" ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Google Sheet
      allData = sortByOrderColumn(allData);

      renderTable(allData);
      setupFilters(allData);
    } catch (err) {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏•‡∏≥‡∏î‡∏±‡∏ö"
  function sortByOrderColumn(data) {
    if (!data || data.length === 0) return data;
    if (!("‡∏•‡∏≥‡∏î‡∏±‡∏ö" in data[0])) return data;

    // clone array ‡∏Å‡∏±‡∏ô side-effect
    const cloned = [...data];
    cloned.sort((a, b) => Number(a["‡∏•‡∏≥‡∏î‡∏±‡∏ö"] || 0) - Number(b["‡∏•‡∏≥‡∏î‡∏±‡∏ö"] || 0));
    return cloned;
  }

  function renderTable(data) {
    if (!data || data.length === 0) {
      $("#detailsTable thead").empty();
      $("#detailsTable tbody").empty();
      return;
    }

    const headers = Object.keys(data[0] || {});
    const thead = $("#detailsTable thead").empty()
      .append(`<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`);
    const tbody = $("#detailsTable tbody").empty();

    data.forEach(row => {
      tbody.append(
        `<tr>${headers.map(h => `<td>${formatCell(h, row[h])}</td>`).join("")}</tr>`
      );
    });

    if ($.fn.DataTable.isDataTable("#detailsTable")) {
      $("#detailsTable").DataTable().destroy();
    }

    dataTable = $("#detailsTable").DataTable({
      scrollX: true,
      pageLength: 10,
      order: [[0, "asc"]], // üîπ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (‡∏•‡∏≥‡∏î‡∏±‡∏ö)
      language: {
        search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
        info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_"
      }
    });
  }

  // ‡πÅ‡∏¢‡∏Å format ‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  function formatCell(header, v) {
    if (v == null || v === "") return "-";

    // üîπ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏•‡∏≥‡∏î‡∏±‡∏ö" ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    if (header === "‡∏•‡∏≥‡∏î‡∏±‡∏ö") {
      return v;
    }

    if (typeof v === "number") return formatNumber(v);
    if (String(v).includes("%")) return v;

    return v;
  }

  function setupFilters(data) {
    const keys = ["‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï", "‡∏ï‡∏≥‡∏ö‡∏•", "‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"];
    const container = $("#filter-section").empty();

    keys.forEach(k => {
      const values = [...new Set(data.map(r => r[k]).filter(Boolean))].sort();
      const select = $(
        `<select data-key="${k}">
           <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
           ${values.map(v => `<option>${v}</option>`).join("")}
         </select>`
      );

      const item = $("<div class='filter-item'></div>");
      item.append(`<label>${k}</label>`);
      item.append(select);
      container.append(item);
    });

    $("#filter-section select").on("change", function () {
      let filtered = [...allData];
      $("#filter-section select").each(function () {
        const key = $(this).data("key");
        const val = $(this).val();
        if (val) filtered = filtered.filter(r => r[key] === val);
      });
      filtered = sortByOrderColumn(filtered); // ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á
      renderTable(filtered);
    });
  }

  function updateSummaryCards(s) {
    $("#num-projects").text(s.totalProjects.toLocaleString("th-TH"));
    $("#approved-money").text(formatNumber(s.approvedMoney));
    $("#debt-start").text(formatNumber(s.debtStart));
    $("#debt-now").text(formatNumber(s.debtNow));
    $("#overdue").text(formatNumber(s.overdue));
    $("#legal").text(formatNumber(s.legal));
    $("#percent-overdue").text(formatPercent(s.percentOverdue));
    $("#update-date").text("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + s.updateDate);
  }

  function downloadData() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(allData);
    XLSX.utils.book_append_sheet(wb, ws, "Province");
    XLSX.writeFile(wb, `${$("#province-title").text()}_KPI69.xlsx`);
  }
</script>

</body>
</html>
