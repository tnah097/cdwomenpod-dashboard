<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>CD Women POD Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />
<style>
/* ======================== üíÖ Global Styles ======================== */
body {
  font-family: 'Sarabun', sans-serif;
  margin: 0;
  background: url('https://www.dga.or.th/wp-content/uploads/2025/06/20250612_074641550_iOS-1120x746.jpg') center/cover no-repeat;
  background-attachment: fixed;
  color: #000;
}
.dashboard-container { padding: 40px; background-color: rgba(255, 255, 255, 0.9); width: 100%; min-height: 100vh; box-sizing: border-box; }
.header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; }
.header-text h1 { margin:0; font-size:2.5rem; }
.header-text h2 { margin:0; font-size:1.5rem; }
.logo-container img { height: 60px; margin-left: 10px; }
.cards { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; }
.card { flex: 1; min-width: 200px; padding: 20px; border-radius: 12px; color: white; font-weight: bold; }
.card .value { font-size: 1.75rem; color: black; margin-top: 10px; font-weight: normal; white-space: nowrap; }
.card.pink { background-color: #e91e63; flex:0 0 auto; width:auto; }
.card.light-pink { background-color: #f8bbd0; }
.card.orange { background-color: #ff9800; }
.card.deep-pastel-pink { background-color: #f06292; }
table.dataTable { width:100% !important; border-collapse: collapse; font-size:0.85rem; color:black; }
table.dataTable th, table.dataTable td { border: 1px solid #ccc; padding: 4px 6px; text-align:center; vertical-align:middle; white-space:nowrap; }
table.dataTable thead th { background-color:#f06292; color:black; font-weight:bold; }
table.dataTable.fixedHeader-floating { background-color: white; }
.src-note { display:block; font-size:0.65rem; color:#555; margin-top:3px; }
.filter-container { display:flex; flex-wrap:wrap; align-items:flex-end; gap:15px; padding:15px; background-color:#f8bbd0; border-radius:8px; margin-bottom:10px; margin-top:20px; }
.filter-item { display:flex; flex-direction:column; min-width:160px; flex-grow:1; }
.filter-item label { font-weight:bold; font-size:0.8rem; margin-bottom:4px; color:#333; }
.filter-item select { width:100%; padding:6px; border:1px solid #aaa; border-radius:4px; font-family:'Sarabun', sans-serif; font-size:0.85rem; height:35px; }
.reset-button-container { flex-grow:1; min-width:160px; }
.reset-button-container button { width:100%; padding:6px 15px; font-family:'Sarabun', sans-serif; font-size:0.9rem; border:none; border-radius:4px; background-color:#d9534f; color:white; cursor:pointer; height:35px; font-weight:bold; }
.reset-button-container button:hover { background-color:#c9302c; }
.dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter { margin-bottom:15px; }
</style>
</head>
<body>
<div class="dashboard-container">
  <div class="header">
    <div class="header-text">
      <h1><span style="color:navy;">CD</span> <span style="color:deeppink;">Women</span> <span style="color:red;">POD</span></h1>
      <h2><span style="color:black;">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span> <span style="color:red;" id="province-title">‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span></h2>
      <div style="color:navy; font-weight:bold; margin-top:8px;">
        <span style="font-size:1.2rem;">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏ï‡∏£‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span><br/>
        <p align="right"><span style="font-size:2rem;" id="update-date">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568</span></p>
      </div>
    </div>
    <div class="logo-container">
      <img src="https://cddadg.cdd.go.th/wp-content/uploads/sites/101/2017/06/CDD-NEW-LOGO3.png" alt="CDD Logo"/>
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Additional Logo"/>
    </div>
  </div>

  <div class="cards">
    <div class="card pink">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£<div class="value" id="num-projects">-</div></div>
    <div class="card light-pink"> ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2567 (A)<div class="value" id="debt-start">-</div>
      ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)<div class="value" id="debt-now">-</div>
    </div>
    <div class="card orange"> ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)<div class="value" id="overdue">-</div>
      ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞<div class="value" id="percent-overdue">-</div>
    </div>
    <div class="card deep-pastel-pink">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<div class="value" id="approved-money">-</div></div>
    <div class="card deep-pastel-pink">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)<div class="value" id="legal">-</div></div>
  </div>

  <h3>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</h3>
  <div id="filter-container" class="filter-container"></div>

  <div class="filter-container">
    <div class="filter-item">
      <label for="downloadType">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô:</label>
      <select id="downloadType">
        <option value="excel">Excel</option>
        <option value="pdf">PDF</option>
      </select>
    </div>
    <div class="reset-button-container">
      <button id="btnDownload">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
    </div>
  </div>

  <table id="districtDetails" class="display" style="width:100%">
    <thead>
      <tr>
        <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï</th><th>‡∏ï‡∏≥‡∏ö‡∏•</th><th>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th><th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th>‡∏á‡∏ß‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
        <th>‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2567 (A)</th><th>‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)</th>
        <th>‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)</th><th>‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)</th>
        <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á(‡∏á1)</th><th>‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á(‡∏á2)</th>
        <th>‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ(‡∏á3)</th><th>‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏°(‡∏á4)</th>
        <th>‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 20 ‡∏ï‡∏£‡∏µ(‡∏á5)</th><th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤(‡∏á6)</th>
        <th>‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)</th>
        <th>‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// ================== Config ==================
const PDPA_ENABLED = true;
const API_URL = "https://script.google.com/macros/s/AKfycbxZ1Mk7z9x7RAyYg4sNSgogwwQbUj8yes4m9IbfUlIqwYqBHvqshGhLrrhUJSXPyjEX/exec";

const KEY_MAP = {
  no:["no","‡∏•‡∏≥‡∏î‡∏±‡∏ö"], district:["district","‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï"], subdistrict:["subdistrict","‡∏ï‡∏≥‡∏ö‡∏•"],
  fiscalYear:["fiscalYear","‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì"], contractNo:["contractNo","‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤"],
  projectName:["projectName","‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"], proposer:["proposer","‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"],
  approvedMoney:["approvedMoney","‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"], startDate:["startDate","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤"],
  endDate:["endDate","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤"], lastPaymentDate:["lastPaymentDate","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"],
  remainingInstallments:["remainingInstallments","‡∏á‡∏ß‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞"],
  debtStart:["debtStart","‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2567 (A)"], debtNow:["debtNow","‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)"],
  notDue:["notDue","‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)"], mediation:["mediation","‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)"],
  prosecutor:["prosecutor","‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á(‡∏á1)"], courtFiled:["courtFiled","‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á(‡∏á2)"],
  judgment:["judgment","‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ(‡∏á3)"], judgmentAgree:["judgmentAgree","‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏°(‡∏á4)"],
  civil20tri:["civil20tri","‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 20 ‡∏ï‡∏£‡∏µ(‡∏á5)"], criminalCase:["criminalCase","‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤(‡∏á6)"],
  legalAction:["legalAction","‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)"],
  overdue:["overdue","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)"], percentOverdue:["percentOverdue","‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞"],
  paymentStatus:["paymentStatus","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ"], projectStatus:["projectStatus","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"], note:["note","‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"]
};

let allData=[], dataTable;

// ================== Utils ==================
function findValue(rowObj, logicalKey){
  const candidates = KEY_MAP[logicalKey]||[logicalKey];
  for(const k of candidates){
    if(Object.prototype.hasOwnProperty.call(rowObj,k) && rowObj[k]!==null && rowObj[k]!=="") return rowObj[k];
  }
  return null;
}

function safeNumberFormat(val){ if(val==null||val==="") return "-"; const s=String(val).replace(/,/g,"").trim(); return isNaN(Number(s))?"-":Number(s).toLocaleString("th-TH",{minimumFractionDigits:2,maximumFractionDigits:2}); }
function safePercentFormat(val){ if(val==null||val==="") return "-"; const s=String(val).replace(/,/g,"").trim(); return isNaN(Number(s))?"-":Number(s).toFixed(2)+"%"; }
function formatDateThai(dateStr){ if(!dateStr) return "-"; const s=String(dateStr).trim(); const parts=s.split("/"); if(parts.length===3){ const d=Number(parts[0]), m=Number(parts[1])-1, y=Number(parts[2]); const dt=new Date(y,m,d); if(!isNaN(dt)) return dt.toLocaleDateString("th-TH"); } const dd=new Date(s); if(!isNaN(dd)) return dd.toLocaleDateString("th-TH"); return s||"-"; }

// ================== Load Data ==================
async function loadData(){
  const params=new URLSearchParams(window.location.search);
  const province=params.get("province")||"";
  if(!province){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ province ‡πÉ‡∏ô URL ‡πÄ‡∏ä‡πà‡∏ô ?province=‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£"); return; }
  document.getElementById("province-title").textContent=province;

  try{
    const res=await fetch(`${API_URL}?province=${encodeURIComponent(province)}`);
    const json=await res.json();
    if(json.error) throw new Error(json.error);

    if(json.summary){
      const s=json.summary;
      document.getElementById("num-projects").textContent=s.totalProjects??"-";
      document.getElementById("approved-money").textContent=safeNumberFormat(s.approvedMoney);
      document.getElementById("debt-start").textContent=safeNumberFormat(s.debtStart);
      document.getElementById("debt-now").textContent=safeNumberFormat(s.debtNow);
      document.getElementById("overdue").textContent=safeNumberFormat(s.overdue);
      document.getElementById("percent-overdue").textContent=safePercentFormat(s.percentOverdue);
      document.getElementById("legal").textContent=safeNumberFormat(s.legal);
      if(s.updateDate) document.getElementById("update-date").textContent="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "+s.updateDate;
    }

    allData=json.data||[];
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ masked ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDPA
    allData=allData.map(row=>{
      row.projectNameReal=row.projectName;
      row.proposerReal=row.proposer;
      if(PDPA_ENABLED) row.projectName="***", row.proposer="***";
      return row;
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á filter dropdown
    createFilters(allData);

    populateTable(allData);
  }catch(err){ alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: "+(err.message||err)); console.error(err);}
}

// ================== Filters ==================
function createFilters(data){
  const container=document.getElementById("filter-container");
  container.innerHTML="";

  const filterKeys=["district","subdistrict","fiscalYear","projectName","projectStatus","note"];
  filterKeys.forEach(key=>{
    const div=document.createElement("div");
    div.className="filter-item";
    div.innerHTML=`<label>${KEY_MAP[key][1]}</label><select id="filter-${key}"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>`;
    container.appendChild(div);

    const select=div.querySelector("select");
    const unique=[...new Set(data.map(r=>findValue(r,key)).filter(v=>v!=null))].sort();
    unique.forEach(v=>{ const opt=document.createElement("option"); opt.value=v; opt.textContent=v; select.appendChild(opt); });
    select.addEventListener("change",applyFilters);
  });
}

function applyFilters(){
  const filters={};
  ["district","subdistrict","fiscalYear","projectName","projectStatus","note"].forEach(key=>{
    const val=document.getElementById(`filter-${key}`).value;
    if(val) filters[key]=val;
  });
  const filtered=allData.filter(row=>{
    return Object.entries(filters).every(([k,v])=>String(findValue(row,k))===v);
  });
  populateTable(filtered);
}

// ================== Populate Table ==================
function populateTable(data){
  if($.fn.dataTable.isDataTable("#districtDetails")) $("#districtDetails").DataTable().destroy();
  const tbody=document.querySelector("#districtDetails tbody");
  tbody.innerHTML="";
  data.forEach((row,index)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=
      `<td>${findValue(row,"no")??(index+1)}</td>
      <td>${findValue(row,"district")??"-"}</td>
      <td>${findValue(row,"subdistrict")??"-"}</td>
      <td>${findValue(row,"fiscalYear")??"-"}</td>
      <td>${findValue(row,"contractNo")??"-"}</td>
      <td>${findValue(row,"projectName")??"-"}</td>
      <td>${findValue(row,"proposer")??"-"}</td>
      <td>${safeNumberFormat(findValue(row,"approvedMoney"))}</td>
      <td>${formatDateThai(findValue(row,"startDate"))}</td>
      <td>${formatDateThai(findValue(row,"endDate"))}</td>
      <td>${formatDateThai(findValue(row,"lastPaymentDate"))}</td>
      <td>${findValue(row,"remainingInstallments")??"-"}</td>
      <td>${safeNumberFormat(findValue(row,"debtStart"))}</td>
      <td>${safeNumberFormat(findValue(row,"debtNow"))}</td>
      <td>${safeNumberFormat(findValue(row,"notDue"))}</td>
      <td>${safeNumberFormat(findValue(row,"mediation"))}</td>
      <td>${safeNumberFormat(findValue(row,"prosecutor"))}</td>
      <td>${safeNumberFormat(findValue(row,"courtFiled"))}</td>
      <td>${safeNumberFormat(findValue(row,"judgment"))}</td>
      <td>${safeNumberFormat(findValue(row,"judgmentAgree"))}</td>
      <td>${safeNumberFormat(findValue(row,"civil20tri"))}</td>
      <td>${safeNumberFormat(findValue(row,"criminalCase"))}</td>
      <td>${safeNumberFormat(findValue(row,"legalAction"))}</td>
      <td>${safeNumberFormat(findValue(row,"overdue"))}</td>
      <td>${safePercentFormat(findValue(row,"percentOverdue"))}</td>
      <td>${findValue(row,"paymentStatus")??"-"}</td>
      <td>${findValue(row,"projectStatus")??"-"}</td>
      <td>${findValue(row,"note")??"-"}</td>`;
    tbody.appendChild(tr);
  });
  dataTable=$("#districtDetails").DataTable({ fixedHeader:true, scrollX:true, pageLength:100, dom:'lfrtip', language:{search:"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á:", lengthMenu:"‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", info:"‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", infoEmpty:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", zeroRecords:"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô", paginate:{first:"‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", last:"‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢", next:"‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", previous:"‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"}} );
}

// ================== PDPA Modal ==================
const pdpaModal=document.createElement("div");
pdpaModal.id="pdpa-modal";
pdpaModal.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:9999;";
pdpaModal.innerHTML=`
<div style="background:white;padding:30px;border-radius:12px;width:400px;text-align:center;">
<h3>‡∏¢‡∏¥‡∏ô‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (PDPA)</h3>
<p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
<button id="pdpa-accept" style="margin-top:15px;padding:8px 20px;font-weight:bold;border-radius:6px;border:none;background-color:#e91e63;color:white;cursor:pointer;">‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö</button>
</div>`;
document.body.appendChild(pdpaModal);
document.getElementById("pdpa-accept").addEventListener("click",()=>{
  pdpaModal.style.display="none";
  allData=allData.map(row=>({...row, projectName: row.projectNameReal, proposer: row.proposerReal}));
  applyFilters();
});

// ================== Download ==================
document.getElementById("btnDownload").addEventListener("click",()=>{
  const type=document.getElementById("downloadType").value;
  if(type==="excel") downloadExcel();
  else if(type==="pdf") downloadPDF();
});
function downloadExcel(){
  if(!allData || allData.length===0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î"); return; }
  const ws=XLSX.utils.json_to_sheet(allData.map(row=>{
    const r={};
    for(const key in row) r[key]=row[key];
    return r;
  }));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Dashboard");
  XLSX.writeFile(wb,"Dashboard.xlsx");
}
function downloadPDF(){
  if(!allData || allData.length===0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î"); return; }
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF('l','pt','a4');
  const columns=Object.values(KEY_MAP).map(arr=>arr[1]);
  const rows=allData.map(row=>columns.map(c=>{
    for(const k in KEY_MAP){ if(KEY_MAP[k][1]===c) return row[k]??"-"; }
    return "-";
  }));
  doc.autoTable({ head:[columns], body:rows, startY:20, styles:{fontSize:7}});
  doc.save("Dashboard.pdf");
}

// ================== Init ==================
loadData();
</script>
</body>
</html>
