<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>CD Women POD Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />
    <style>
        /* ======================== üíÖ Global Styles ======================== */
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            background: url('https://www.dga.or.th/wp-content/uploads/2025/06/20250612_074641550_iOS-1120x746.jpg') center/cover no-repeat;
            background-attachment: fixed;
            color: #000;
        }

        .dashboard-container {
            padding: 40px;
            background-color: rgba(255, 255, 255, 0.9);
            width: 100%;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Header Section */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .header-text h1 { margin: 0; font-size: 2.5rem; }
        .header-text h2 { margin: 0; font-size: 1.5rem; }

        .logo-container img {
            height: 60px;
            margin-left: 10px;
        }

        /* Cards */
        .cards {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
        }

        .card .value {
            font-size: 1.75rem;
            color: black;
            margin-top: 10px;
            font-weight: normal;
            white-space: nowrap;
        }

        .card.pink { background-color: #e91e63; flex: 0 0 auto; width: auto; }
        .card.light-pink { background-color: #f8bbd0; }
        .card.orange { background-color: #ff9800; }
        .card.deep-pastel-pink { background-color: #f06292; }

        /* Tables */
        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
            font-size: 0.85rem;
            color: black;
        }

        table.dataTable th,
        table.dataTable td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
        }

        table.dataTable thead th {
            background-color: #f06292;
            color: black;
            font-weight: bold;
        }
        
        table.dataTable.fixedHeader-floating { background-color: white; }

        /* Filters */
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 15px;
            padding: 15px;
            background-color: #f8bbd0;
            border-radius: 8px;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 160px;
            flex-grow: 1;
        }

        .filter-item label {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: #333;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 6px;
            border: 1px solid #aaa;
            border-radius: 4px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.85rem;
            height: 35px;
            box-sizing: border-box;
        }

        .action-button-container {
            display: flex;
            gap: 10px;
            min-width: 160px;
            flex-grow: 1;
        }

        .action-button-container button {
            flex-grow: 1;
            padding: 6px 15px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.9rem;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            height: 35px;
            font-weight: bold;
        }

        #btnResetFilter { background-color: #d9534f; }
        #btnResetFilter:hover { background-color: #c9302c; }
        #btnDownload { background-color: #5cb85c; }
        #btnDownload:hover { background-color: #4cae4c; }

        /* PDPA Modal */
        #pdpa-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        .pdpa-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #pdpa-accept {
            margin-top: 15px;
            padding: 10px 25px;
            font-weight: bold;
            font-size: 1rem;
            border-radius: 6px;
            border: none;
            background-color: #e91e63;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #pdpa-accept:hover { background-color: #c2185b; }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="header-text">
                <h1><span style="color:navy;">CD</span> <span style="color:deeppink;">Women</span> <span style="color:red;">POD</span></h1>
                <h2><span style="color:black;">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span> <span style="color:red;" id="province-title">‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span></h2>
                <div style="color:navy; font-weight:bold; margin-top:8px;">
                    <span style="font-size:1.2rem;">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏ï‡∏£‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span><br />
                    <p align="right"><span style="font-size:2rem;" id="update-date">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span></p>
                </div>
            </div>
            <div class="logo-container">
                <img src="https://cddadg.cdd.go.th/wp-content/uploads/sites/101/2017/06/CDD-NEW-LOGO3.png" alt="CDD Logo" />
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s" alt="Additional Logo" />
            </div>
        </div>

        <div class="cards">
            <div class="card pink">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£<div class="value" id="num-projects">-</div></div>
            <div class="card light-pink"> ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2567 (A)<div class="value" id="debt-start">-</div> ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)<div class="value" id="debt-now">-</div></div>
            <div class="card orange"> ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)<div class="value" id="overdue">-</div> ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞<div class="value" id="percent-overdue">-</div></div>
            <div class="card deep-pastel-pink">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<div class="value" id="approved-money">-</div></div>
            <div class="card deep-pastel-pink">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)<div class="value" id="legal">-</div></div>
        </div>

        <h3>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div id="filter-section" class="filter-container">
            </div>
        
        <div class="filter-container">
             <div class="filter-item">
                <label for="downloadType">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô:</label>
                <select id="downloadType">
                    <option value="excel">Excel</option>
                    <option value="pdf">PDF</option>
                </select>
            </div>
            <div class="action-button-container">
                <button id="btnDownload">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
                <button id="btnResetFilter">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
            </div>
        </div>

        <h3>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</h3>
        <table id="detailsTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï</th><th>‡∏ï‡∏≥‡∏ö‡∏•</th><th>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th><th>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th>‡∏á‡∏ß‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                    <th>‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2567 (A)</th><th>‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)</th>
                    <th>‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)</th><th>‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)</th>
                    <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á(‡∏á1)</th><th>‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á(‡∏á2)</th>
                    <th>‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ(‡∏á3)</th><th>‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏°(‡∏á4)</th>
                    <th>‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 20 ‡∏ï‡∏£‡∏µ(‡∏á5)</th><th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤(‡∏á6)</th>
                    <th>‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)</th>
                    <th>‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pdpa-modal">
        <div class="pdpa-content">
            <h3>‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Dashboard ‡∏ô‡∏µ‡πâ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ("‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" ‡πÅ‡∏•‡∏∞ "‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£") ‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö. ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏û.‡∏®. 2562 ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            <button id="pdpa-accept">‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Dashboard</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        // ================== Config ==================
        const PDPA_ENABLED = true;
        const API_URL = "https://script.google.com/macros/s/AKfycbxZ1Mk7z9x7RAyYg4sNSgogwwQbUj8yes4m9IbfUlIqwYqBHvqshGhLrrhUJSXPyjEX/exec";
        
        let allData = [], dataTable, fullData = [];

        // ================== Utils ==================
        const formatValue = (val) => (val === null || val === undefined || val === "") ? "-" : val;
        const formatNumber = (val) => {
            const num = parseFloat(String(val).replace(/,/g, ''));
            return !isNaN(num) ? num.toLocaleString("th-TH", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "-";
        };
        const formatPercent = (val) => {
            const num = parseFloat(String(val).replace(/,/g, ''));
            return !isNaN(num) ? `${num.toFixed(2)}%` : "-";
        };
        const formatDate = (dateStr) => {
            if (!dateStr) return "-";
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return formatValue(dateStr);
                return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) {
                return formatValue(dateStr);
            }
        };

        // ================== Main Logic ==================
        $(document).ready(function() {
            if (!PDPA_ENABLED) {
                $("#pdpa-modal").hide();
                initializeDashboard();
            }

            $("#pdpa-accept").on("click", function() {
                $("#pdpa-modal").fadeOut(300, () => {
                     initializeDashboard(true);
                });
            });

            $("#btnResetFilter").on("click", resetFilters);
            $("#btnDownload").on("click", downloadData);
        });

        async function initializeDashboard(pdpaAccepted = false) {
            const params = new URLSearchParams(window.location.search);
            const province = params.get("province");
            if (!province) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ 'province' ‡πÉ‡∏ô URL (‡πÄ‡∏ä‡πà‡∏ô ?province=‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£)");
                return;
            }
            $("#province-title").text(province);

            try {
                const res = await fetch(`${API_URL}?province=${encodeURIComponent(province)}`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const json = await res.json();
                if (json.error) throw new Error(json.error);

                fullData = json.data || [];
                
                if (pdpaAccepted) {
                    allData = fullData; // Use full data after accept
                } else {
                    // Mask data before accept
                    allData = fullData.map(row => ({
                        ...row,
                        projectName: "***",
                        proposer: "***"
                    }));
                }

                updateSummaryCards(json.summary);
                populateFilters(allData);
                populateTable(allData);
                updateSummaryCards(calculateSummary(allData)); 
                
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + (err.message || err));
                console.error(err);
            }
        }

        function populateTable(data) {
            if ($.fn.DataTable.isDataTable("#detailsTable")) {
                dataTable.clear().destroy();
            }

            const tbody = $("#detailsTable tbody");
            tbody.empty();
            
            data.forEach((row, index) => {
                const tr = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formatValue(row.district)}</td>
                        <td>${formatValue(row.subdistrict)}</td>
                        <td>${formatValue(row.fiscalYear)}</td>
                        <td>${formatValue(row.contractNo)}</td>
                        <td>${formatValue(row.projectName)}</td>
                        <td>${formatValue(row.proposer)}</td>
                        <td>${formatNumber(row.approvedMoney)}</td>
                        <td>${formatDate(row.startDate)}</td>
                        <td>${formatDate(row.endDate)}</td>
                        <td>${formatDate(row.lastPaymentDate)}</td>
                        <td>${formatValue(row.remainingInstallments)}</td>
                        <td>${formatNumber(row.debtStart)}</td>
                        <td>${formatNumber(row.debtNow)}</td>
                        <td>${formatNumber(row.notDue)}</td>
                        <td>${formatNumber(row.mediation)}</td>
                        <td>${formatNumber(row.prosecutor)}</td>
                        <td>${formatNumber(row.courtFiled)}</td>
                        <td>${formatNumber(row.judgment)}</td>
                        <td>${formatNumber(row.judgmentAgree)}</td>
                        <td>${formatNumber(row.civil20tri)}</td>
                        <td>${formatNumber(row.criminalCase)}</td>
                        <td>${formatNumber(row.legalAction)}</td>
                        <td>${formatNumber(row.overdue)}</td>
                        <td>${formatPercent(row.percentOverdue)}</td>
                        <td>${formatValue(row.paymentStatus)}</td>
                        <td>${formatValue(row.projectStatus)}</td>
                        <td>${formatValue(row.note)}</td>
                    </tr>`;
                tbody.append(tr);
            });
            
            dataTable = $("#detailsTable").DataTable({
                fixedHeader: true,
                scrollX: true,
                pageLength: 100,
                dom: 'lfrtip',
                language: {
                    search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á:",
                    lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    infoEmpty: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                    zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô",
                    paginate: { first: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", last: "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢", next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" }
                }
            });
        }
        
        function populateFilters(data) {
            const filters = {
                district: { label: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï', values: new Set() },
                subdistrict: { label: '‡∏ï‡∏≥‡∏ö‡∏•', values: new Set() },
                fiscalYear: { label: '‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì', values: new Set() },
                projectName: { label: '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', values: new Set() },
                projectStatus: { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', values: new Set() },
                note: { label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', values: new Set() }
            };

            data.forEach(row => {
                Object.keys(filters).forEach(key => {
                    if (row[key]) filters[key].values.add(row[key]);
                });
            });

            const filterContainer = $("#filter-section");
            filterContainer.empty();

            Object.keys(filters).forEach(key => {
                const filter = filters[key];
                const select = $(`<select id="filter-${key}" data-key="${key}"><option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option></select>`);
                
                // Sort values before appending. For fiscalYear, sort numerically.
                const sortedValues = Array.from(filter.values).sort((a, b) => {
                    if (key === 'fiscalYear') {
                        return Number(b) - Number(a); // Newest year first
                    }
                    return String(a).localeCompare(String(b), 'th');
                });

                sortedValues.forEach(val => {
                    select.append(`<option value="${val}">${val}</option>`);
                });

                const filterItem = $(`<div class="filter-item"><label for="filter-${key}">${filter.label}:</label></div>`);
                filterItem.append(select);
                filterContainer.append(filterItem);
            });
            
            $("#filter-section select").on("change", applyFilters);
        }

        function applyFilters() {
            let filteredData = [...allData];
            const activeFilters = $("#filter-section select").map(function() {
                return { key: $(this).data('key'), value: $(this).val() };
            }).get();

            activeFilters.forEach(filter => {
                if (filter.value) {
                    filteredData = filteredData.filter(row => String(row[filter.key] || '') === String(filter.value));
                }
            });

            populateTable(filteredData);
            updateSummaryCards(calculateSummary(filteredData));
        }

        function resetFilters() {
            $("#filter-section select").val("").trigger("change");
        }

        // ================== Summary Cards ==================
        function updateSummaryCards(summary) {
            if (!summary) return;
            $("#num-projects").text(summary.totalProjects?.toLocaleString('th-TH') ?? "-");
            $("#approved-money").text(formatNumber(summary.approvedMoney));
            $("#debt-start").text(formatNumber(summary.debtStart));
            $("#debt-now").text(formatNumber(summary.debtNow));
            $("#overdue").text(formatNumber(summary.overdue));
            $("#legal").text(formatNumber(summary.legal));
            $("#percent-overdue").text(formatPercent(summary.percentOverdue));

            if (summary.updateDate) {
                $("#update-date").text("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + summary.updateDate);
            }
        }
        
        function calculateSummary(data) {
            const summary = data.reduce((acc, row) => {
                acc.approvedMoney += parseFloat(row.approvedMoney) || 0;
                acc.debtStart += parseFloat(row.debtStart) || 0;
                acc.debtNow += parseFloat(row.debtNow) || 0;
                acc.overdue += parseFloat(row.overdue) || 0;
                acc.legal += parseFloat(row.legalAction) || 0;
                return acc;
            }, {
                approvedMoney: 0, debtStart: 0, debtNow: 0, overdue: 0, legal: 0
            });
            
            summary.totalProjects = data.length;
            summary.percentOverdue = summary.debtNow > 0 ? (summary.overdue / summary.debtNow) * 100 : 0;
            return summary;
        }

        // ================== Download ==================
        function downloadData() {
            const type = $("#downloadType").val();
            const dataToDownload = dataTable.rows({ search: 'applied' }).data().toArray().map(rowHtml => {
                const cells = $(rowHtml).find('td');
                // This mapping needs to be robust, matching table headers
                return {
                    '‡∏•‡∏≥‡∏î‡∏±‡∏ö': cells.eq(0).text(), '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï': cells.eq(1).text(), '‡∏ï‡∏≥‡∏ö‡∏•': cells.eq(2).text(),
                    '‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì': cells.eq(3).text(), '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤': cells.eq(4).text(), '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£': cells.eq(5).text(),
                    '‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£': cells.eq(6).text(), '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥': cells.eq(7).text(), '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤': cells.eq(8).text(),
                    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤': cells.eq(9).text(), '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î': cells.eq(10).text(), '‡∏á‡∏ß‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': cells.eq(11).text(),
                    '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2567 (A)': cells.eq(12).text(), '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)': cells.eq(13).text(),
                    '‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)': cells.eq(14).text(), '‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏Ø (‡∏Ñ)': cells.eq(15).text(),
                    '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á(‡∏á1)': cells.eq(16).text(), '‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á(‡∏á2)': cells.eq(17).text(),
                    '‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏Ø(‡∏á3)': cells.eq(18).text(), '‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏°(‡∏á4)': cells.eq(19).text(),
                    '‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 20 ‡∏ï‡∏£‡∏µ(‡∏á5)': cells.eq(20).text(), '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤(‡∏á6)': cells.eq(21).text(),
                    '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)': cells.eq(22).text(), '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)': cells.eq(23).text(),
                    '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞': cells.eq(24).text(), '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ': cells.eq(25).text(),
                    '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£': cells.eq(26).text(), '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': cells.eq(27).text()
                };
            });


            if (dataToDownload.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á)");
                return;
            }

            if (type === "excel") downloadExcel(dataToDownload);
            else if (type === "pdf") downloadPDF(dataToDownload);
        }

        function downloadExcel(data) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DashboardData");
            XLSX.writeFile(wb, "CD_Women_POD_Dashboard.xlsx");
        }

        function downloadPDF(data) {
            alert("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ jsPDF ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Excel ‡∏Ñ‡∏£‡∏±‡∏ö");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            
            const head = [Object.keys(data[0])];
            const body = data.map(row => Object.values(row));
            
            doc.autoTable({
                head: head,
                body: body,
                startY: 20,
                styles: { fontSize: 5 }, // Font size needs to be very small for many columns
                headStyles: { fillColor: [240, 98, 146] }, // Pink header
                theme: 'grid'
            });

            doc.save("CD_Women_POD_Dashboard.pdf");
        }
    </script>
</body>
</html>
